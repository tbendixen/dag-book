<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Adventures in G-methods | The Data Analyst’s Guide to Cause and Effect</title>
  <meta name="description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Adventures in G-methods | The Data Analyst’s Guide to Cause and Effect" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  <meta name="github-repo" content="tbendixen/DAG-companion" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Adventures in G-methods | The Data Analyst’s Guide to Cause and Effect" />
  
  <meta name="twitter:description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  

<meta name="author" content="Theiss Bendixen &amp; Benjamin Grant Purzycki" />


<meta name="date" content="2024-10-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="gmethods.html"/>
<link rel="next" href="miss.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Data Analyst's Guide to Cause and Effect</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome!</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="dag.html"><a href="dag.html"><i class="fa fa-check"></i><b>2</b> Causal Graphs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="dag.html"><a href="dag.html#the-fork"><i class="fa fa-check"></i><b>2.1</b> The Fork</a></li>
<li class="chapter" data-level="2.2" data-path="dag.html"><a href="dag.html#the-pipe"><i class="fa fa-check"></i><b>2.2</b> The Pipe</a></li>
<li class="chapter" data-level="2.3" data-path="dag.html"><a href="dag.html#the-collider"><i class="fa fa-check"></i><b>2.3</b> The Collider</a></li>
<li class="chapter" data-level="2.4" data-path="dag.html"><a href="dag.html#post-treatment-bias"><i class="fa fa-check"></i><b>2.4</b> Post-treatment bias</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="gmethods.html"><a href="gmethods.html"><i class="fa fa-check"></i><b>3</b> G-methods and Marginal Effects</a>
<ul>
<li class="chapter" data-level="3.1" data-path="gmethods.html"><a href="gmethods.html#inverse-probability-weighting"><i class="fa fa-check"></i><b>3.1</b> Inverse probability weighting</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="gmethods.html"><a href="gmethods.html#bootstrapping"><i class="fa fa-check"></i><b>3.1.1</b> Bootstrapping</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="gmethods.html"><a href="gmethods.html#g-computation"><i class="fa fa-check"></i><b>3.2</b> G-computation</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="gmethods.html"><a href="gmethods.html#bootstrapping-1"><i class="fa fa-check"></i><b>3.2.1</b> Bootstrapping</a></li>
<li class="chapter" data-level="3.2.2" data-path="gmethods.html"><a href="gmethods.html#bayesian-g-computation"><i class="fa fa-check"></i><b>3.2.2</b> Bayesian g-computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gmethods2.html"><a href="gmethods2.html"><i class="fa fa-check"></i><b>4</b> Adventures in G-methods</a>
<ul>
<li class="chapter" data-level="4.1" data-path="gmethods2.html"><a href="gmethods2.html#doubly-robust-estimation"><i class="fa fa-check"></i><b>4.1</b> Doubly robust estimation</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="gmethods2.html"><a href="gmethods2.html#bootstrapping-2"><i class="fa fa-check"></i><b>4.1.1</b> Bootstrapping</a></li>
<li class="chapter" data-level="4.1.2" data-path="gmethods2.html"><a href="gmethods2.html#more-covariates"><i class="fa fa-check"></i><b>4.1.2</b> More covariates</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="gmethods2.html"><a href="gmethods2.html#bootstrapped-sub-group-analysis"><i class="fa fa-check"></i><b>4.2</b> Bootstrapped sub-group analysis</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="miss.html"><a href="miss.html"><i class="fa fa-check"></i><b>5</b> Most of Your Data is Almost Always Missing</a>
<ul>
<li class="chapter" data-level="5.1" data-path="miss.html"><a href="miss.html#simulating-missingness"><i class="fa fa-check"></i><b>5.1</b> Simulating missingness</a></li>
<li class="chapter" data-level="5.2" data-path="miss.html"><a href="miss.html#poststratification"><i class="fa fa-check"></i><b>5.2</b> Poststratification</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="miss.html"><a href="miss.html#frequentist-poststratification"><i class="fa fa-check"></i><b>5.2.1</b> Frequentist poststratification</a></li>
<li class="chapter" data-level="5.2.2" data-path="miss.html"><a href="miss.html#bayesian-poststratification"><i class="fa fa-check"></i><b>5.2.2</b> Bayesian poststratification</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="miss.html"><a href="miss.html#instrumental-variable-analysis"><i class="fa fa-check"></i><b>5.3</b> Instrumental variable analysis</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="miss.html"><a href="miss.html#preparing-cohen-et-al.-2015"><i class="fa fa-check"></i><b>5.3.1</b> Preparing Cohen et al. (2015)</a></li>
<li class="chapter" data-level="5.3.2" data-path="miss.html"><a href="miss.html#randomized-treatment-assignment-as-instrument"><i class="fa fa-check"></i><b>5.3.2</b> Randomized treatment assignment as instrument</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="miss.html"><a href="miss.html#bayesian-instrumental-variable-analysis"><i class="fa fa-check"></i><b>5.4</b> Bayesian instrumental variable analysis</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="miss2.html"><a href="miss2.html"><i class="fa fa-check"></i><b>6</b> More Missing Data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="miss2.html"><a href="miss2.html#simple-mean-imputation-vs.-multiple-imputation"><i class="fa fa-check"></i><b>6.1</b> Simple mean imputation vs. multiple imputation</a></li>
<li class="chapter" data-level="6.2" data-path="miss2.html"><a href="miss2.html#combine-then-predict-or-predict-then-combine"><i class="fa fa-check"></i><b>6.2</b> “Combine then predict” or “predict then combine”?</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="miss2.html"><a href="miss2.html#marginaleffects"><i class="fa fa-check"></i><b>6.2.1</b> <code>marginaleffects</code></a></li>
<li class="chapter" data-level="6.2.2" data-path="miss2.html"><a href="miss2.html#emmeans"><i class="fa fa-check"></i><b>6.2.2</b> <code>emmeans</code></a></li>
<li class="chapter" data-level="6.2.3" data-path="miss2.html"><a href="miss2.html#comparison"><i class="fa fa-check"></i><b>6.2.3</b> Comparison</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="miss2.html"><a href="miss2.html#bayesian-imputation"><i class="fa fa-check"></i><b>6.3</b> Bayesian imputation</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="advest.html"><a href="advest.html"><i class="fa fa-check"></i><b>7</b> Advanced Estimation</a>
<ul>
<li class="chapter" data-level="7.1" data-path="advest.html"><a href="advest.html#multilevel-malaria-medicine"><i class="fa fa-check"></i><b>7.1</b> Multilevel malaria medicine</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="advest.html"><a href="advest.html#naïve-model-simple-intercept-and-slope"><i class="fa fa-check"></i><b>7.1.1</b> Naïve model: Simple intercept and slope</a></li>
<li class="chapter" data-level="7.1.2" data-path="advest.html"><a href="advest.html#fixed-effects"><i class="fa fa-check"></i><b>7.1.2</b> Fixed effects</a></li>
<li class="chapter" data-level="7.1.3" data-path="advest.html"><a href="advest.html#fixed-effects-interacting-treatment-and-group"><i class="fa fa-check"></i><b>7.1.3</b> Fixed effects interacting treatment and group</a></li>
<li class="chapter" data-level="7.1.4" data-path="advest.html"><a href="advest.html#random-intercepts"><i class="fa fa-check"></i><b>7.1.4</b> Random intercepts</a></li>
<li class="chapter" data-level="7.1.5" data-path="advest.html"><a href="advest.html#random-intercepts-and-slopes"><i class="fa fa-check"></i><b>7.1.5</b> Random intercepts and slopes</a></li>
<li class="chapter" data-level="7.1.6" data-path="advest.html"><a href="advest.html#plot-models-in-a-panel"><i class="fa fa-check"></i><b>7.1.6</b> Plot models in a panel</a></li>
<li class="chapter" data-level="7.1.7" data-path="advest.html"><a href="advest.html#regularized-vs.-empirical-estimates"><i class="fa fa-check"></i><b>7.1.7</b> Regularized vs. empirical estimates</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="advest.html"><a href="advest.html#simulating-mundlak"><i class="fa fa-check"></i><b>7.2</b> Simulating Mundlak</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="advest.html"><a href="advest.html#naïve-model-ignoring-group"><i class="fa fa-check"></i><b>7.2.1</b> Naïve model (ignoring group)</a></li>
<li class="chapter" data-level="7.2.2" data-path="advest.html"><a href="advest.html#fixed-effects-1"><i class="fa fa-check"></i><b>7.2.2</b> Fixed effects</a></li>
<li class="chapter" data-level="7.2.3" data-path="advest.html"><a href="advest.html#random-intercepts-1"><i class="fa fa-check"></i><b>7.2.3</b> Random intercepts</a></li>
<li class="chapter" data-level="7.2.4" data-path="advest.html"><a href="advest.html#mundlak-model"><i class="fa fa-check"></i><b>7.2.4</b> Mundlak model</a></li>
<li class="chapter" data-level="7.2.5" data-path="advest.html"><a href="advest.html#plot-effect-estimate-distributions"><i class="fa fa-check"></i><b>7.2.5</b> Plot effect estimate distributions</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="advest.html"><a href="advest.html#education-and-prosociality-mundlak-in-action"><i class="fa fa-check"></i><b>7.3</b> Education and prosociality: Mundlak in action</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="advest.html"><a href="advest.html#raw-data-distributions"><i class="fa fa-check"></i><b>7.3.1</b> Raw data distributions</a></li>
<li class="chapter" data-level="7.3.2" data-path="advest.html"><a href="advest.html#naïve-model"><i class="fa fa-check"></i><b>7.3.2</b> Naïve model</a></li>
<li class="chapter" data-level="7.3.3" data-path="advest.html"><a href="advest.html#fixed-effects-2"><i class="fa fa-check"></i><b>7.3.3</b> Fixed effects</a></li>
<li class="chapter" data-level="7.3.4" data-path="advest.html"><a href="advest.html#random-effects"><i class="fa fa-check"></i><b>7.3.4</b> Random effects</a></li>
<li class="chapter" data-level="7.3.5" data-path="advest.html"><a href="advest.html#mundlak-model-1"><i class="fa fa-check"></i><b>7.3.5</b> Mundlak model</a></li>
<li class="chapter" data-level="7.3.6" data-path="advest.html"><a href="advest.html#plotting-effect-of-education-on-religiosity"><i class="fa fa-check"></i><b>7.3.6</b> Plotting effect of education on religiosity</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="advest.html"><a href="advest.html#marginal-effects-in-a-multilevel-model"><i class="fa fa-check"></i><b>7.4</b> Marginal effects in a multilevel model</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="advest.html"><a href="advest.html#frequentist-workflow"><i class="fa fa-check"></i><b>7.4.1</b> Frequentist workflow</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>The Data Analyst’s Guide to Cause and Effect</em></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="gmethods2" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Adventures in G-methods<a href="gmethods2.html#gmethods2" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="doubly-robust-estimation" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Doubly robust estimation<a href="gmethods2.html#doubly-robust-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For demonstrating a ‘doubly robust’ estimator that combines IPW and g-computation, we use the <code>nhefs</code> data from the <code>causaldata</code> package. This data come from the National Health and Nutrition Examination Survey Data I Epidemiologic Follow-up Study.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="gmethods2.html#cb37-1" tabindex="-1"></a><span class="fu">library</span>(causaldata)</span>
<span id="cb37-2"><a href="gmethods2.html#cb37-2" tabindex="-1"></a>d <span class="ot">&lt;-</span> nhefs</span></code></pre></div>
<p>We first calculate stabilized IP weights.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="gmethods2.html#cb38-1" tabindex="-1"></a>treat_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> sex <span class="sc">+</span> age,</span>
<span id="cb38-2"><a href="gmethods2.html#cb38-2" tabindex="-1"></a>                 <span class="at">data =</span> d,</span>
<span id="cb38-3"><a href="gmethods2.html#cb38-3" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb38-4"><a href="gmethods2.html#cb38-4" tabindex="-1"></a></span>
<span id="cb38-5"><a href="gmethods2.html#cb38-5" tabindex="-1"></a>d<span class="sc">$</span>pX <span class="ot">&lt;-</span> <span class="fu">predict</span>(treat_mod, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb38-6"><a href="gmethods2.html#cb38-6" tabindex="-1"></a></span>
<span id="cb38-7"><a href="gmethods2.html#cb38-7" tabindex="-1"></a>pn <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb38-8"><a href="gmethods2.html#cb38-8" tabindex="-1"></a>          <span class="at">data =</span> d,</span>
<span id="cb38-9"><a href="gmethods2.html#cb38-9" tabindex="-1"></a>          <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb38-10"><a href="gmethods2.html#cb38-10" tabindex="-1"></a></span>
<span id="cb38-11"><a href="gmethods2.html#cb38-11" tabindex="-1"></a>d<span class="sc">$</span>pnX <span class="ot">&lt;-</span> <span class="fu">predict</span>(pn, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb38-12"><a href="gmethods2.html#cb38-12" tabindex="-1"></a>  </span>
<span id="cb38-13"><a href="gmethods2.html#cb38-13" tabindex="-1"></a>d<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">with</span>(d, <span class="fu">ifelse</span>(qsmk<span class="sc">==</span><span class="dv">1</span>, pnX<span class="sc">/</span>pX, (<span class="dv">1</span><span class="sc">-</span>pnX)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pX)))</span></code></pre></div>
<p>We can then plot the sample before and after weighting.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="gmethods2.html#cb39-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb39-2"><a href="gmethods2.html#cb39-2" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb39-3"><a href="gmethods2.html#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a href="gmethods2.html#cb39-4" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb39-5"><a href="gmethods2.html#cb39-5" tabindex="-1"></a>  <span class="co"># X = 1 (sample)</span></span>
<span id="cb39-6"><a href="gmethods2.html#cb39-6" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">subset</span>(d, qsmk <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb39-7"><a href="gmethods2.html#cb39-7" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> pX), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb39-8"><a href="gmethods2.html#cb39-8" tabindex="-1"></a>  <span class="co"># X = 0 (sample)</span></span>
<span id="cb39-9"><a href="gmethods2.html#cb39-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">subset</span>(d, qsmk <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb39-10"><a href="gmethods2.html#cb39-10" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> pX), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb39-11"><a href="gmethods2.html#cb39-11" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb39-12"><a href="gmethods2.html#cb39-12" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-13"><a href="gmethods2.html#cb39-13" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-14"><a href="gmethods2.html#cb39-14" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-15"><a href="gmethods2.html#cb39-15" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-16"><a href="gmethods2.html#cb39-16" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span> </span>
<span id="cb39-17"><a href="gmethods2.html#cb39-17" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Probability of treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-18"><a href="gmethods2.html#cb39-18" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Before IP weighting&quot;</span>)</span>
<span id="cb39-19"><a href="gmethods2.html#cb39-19" tabindex="-1"></a></span>
<span id="cb39-20"><a href="gmethods2.html#cb39-20" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb39-21"><a href="gmethods2.html#cb39-21" tabindex="-1"></a>  <span class="co"># X = 1 (pseudo-population)</span></span>
<span id="cb39-22"><a href="gmethods2.html#cb39-22" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">subset</span>(d, qsmk <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb39-23"><a href="gmethods2.html#cb39-23" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> pX, <span class="at">weight =</span> sw), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb39-24"><a href="gmethods2.html#cb39-24" tabindex="-1"></a>  <span class="co"># X = 0 (pseudo-population)</span></span>
<span id="cb39-25"><a href="gmethods2.html#cb39-25" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">subset</span>(d, qsmk <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb39-26"><a href="gmethods2.html#cb39-26" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> pX, <span class="at">weight =</span> sw), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb39-27"><a href="gmethods2.html#cb39-27" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb39-28"><a href="gmethods2.html#cb39-28" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-29"><a href="gmethods2.html#cb39-29" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-30"><a href="gmethods2.html#cb39-30" tabindex="-1"></a>  <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-31"><a href="gmethods2.html#cb39-31" tabindex="-1"></a>  <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-32"><a href="gmethods2.html#cb39-32" tabindex="-1"></a>  <span class="at">axis.line.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span> </span>
<span id="cb39-33"><a href="gmethods2.html#cb39-33" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Probability of treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-34"><a href="gmethods2.html#cb39-34" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;After IP weighting&quot;</span>) </span>
<span id="cb39-35"><a href="gmethods2.html#cb39-35" tabindex="-1"></a></span>
<span id="cb39-36"><a href="gmethods2.html#cb39-36" tabindex="-1"></a>(p1 <span class="sc">+</span> p2)</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch4-fig-unnamed-chunk-33-1.png" width="480" /></p>
<p>We can also make a ‘love plot’ using the <strong>cobalt</strong> package to inspect whether the IP weights ensures acceptable balance on the level of individual covariates. By setting <code>continuous = "std"</code>, we indicate that the function should return the <em>standardized</em> absolute mean difference for any continuous variables (here, <code>age</code>). If we wanted the raw absolute mean difference, we’d set <code>continuous = "raw"</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="gmethods2.html#cb40-1" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb40-2"><a href="gmethods2.html#cb40-2" tabindex="-1"></a></span>
<span id="cb40-3"><a href="gmethods2.html#cb40-3" tabindex="-1"></a><span class="fu">love.plot</span>(treat_mod, <span class="at">abs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-4"><a href="gmethods2.html#cb40-4" tabindex="-1"></a>          <span class="at">sample.names =</span> <span class="fu">c</span>(<span class="st">&quot;Unweighted&quot;</span>, <span class="st">&quot;IP Weighted&quot;</span>), </span>
<span id="cb40-5"><a href="gmethods2.html#cb40-5" tabindex="-1"></a>          <span class="at">weights =</span> d<span class="sc">$</span>sw,</span>
<span id="cb40-6"><a href="gmethods2.html#cb40-6" tabindex="-1"></a>          <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&quot;grey60&quot;</span>, <span class="st">&quot;black&quot;</span>),</span>
<span id="cb40-7"><a href="gmethods2.html#cb40-7" tabindex="-1"></a>          <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>))</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch4-fig-unnamed-chunk-34-1.png" width="480" /></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="gmethods2.html#cb41-1" tabindex="-1"></a><span class="fu">bal.tab</span>(treat_mod, <span class="at">abs =</span> <span class="cn">TRUE</span>, <span class="at">un =</span> <span class="cn">TRUE</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>), <span class="at">weights =</span> d<span class="sc">$</span>sw, <span class="at">continuous =</span> <span class="st">&quot;std&quot;</span>)<span class="sc">$</span>Balance</span></code></pre></div>
<p>Finally, we include the stabilized weights in an outcome model, which we in turn use for g-computation.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="gmethods2.html#cb42-1" tabindex="-1"></a>out_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> sex <span class="sc">+</span> age, <span class="at">data =</span> d, <span class="at">weights =</span> sw)</span>
<span id="cb42-2"><a href="gmethods2.html#cb42-2" tabindex="-1"></a></span>
<span id="cb42-3"><a href="gmethods2.html#cb42-3" tabindex="-1"></a>EX1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb42-4"><a href="gmethods2.html#cb42-4" tabindex="-1"></a>               <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">1</span>))</span>
<span id="cb42-5"><a href="gmethods2.html#cb42-5" tabindex="-1"></a></span>
<span id="cb42-6"><a href="gmethods2.html#cb42-6" tabindex="-1"></a>EX0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb42-7"><a href="gmethods2.html#cb42-7" tabindex="-1"></a>               <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">0</span>))</span>
<span id="cb42-8"><a href="gmethods2.html#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a href="gmethods2.html#cb42-9" tabindex="-1"></a><span class="fu">mean</span>(EX1)<span class="sc">-</span><span class="fu">mean</span>(EX0)</span></code></pre></div>
<pre><code>## [1] 3.039286</code></pre>
<div id="bootstrapping-2" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Bootstrapping<a href="gmethods2.html#bootstrapping-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The basic approach to bootstrapping is similar as in the previous chapter. Here, we bootstrap the doubly robust estimator from above. We use only 100 bootstrap samples, but in practice we’d often want more.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="gmethods2.html#cb44-1" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb44-2"><a href="gmethods2.html#cb44-2" tabindex="-1"></a></span>
<span id="cb44-3"><a href="gmethods2.html#cb44-3" tabindex="-1"></a><span class="co"># Number of bootstrap samples</span></span>
<span id="cb44-4"><a href="gmethods2.html#cb44-4" tabindex="-1"></a>n_bootstrap <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb44-5"><a href="gmethods2.html#cb44-5" tabindex="-1"></a></span>
<span id="cb44-6"><a href="gmethods2.html#cb44-6" tabindex="-1"></a>bootstrap_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb44-7"><a href="gmethods2.html#cb44-7" tabindex="-1"></a>    </span>
<span id="cb44-8"><a href="gmethods2.html#cb44-8" tabindex="-1"></a>    <span class="co"># Resample the data</span></span>
<span id="cb44-9"><a href="gmethods2.html#cb44-9" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data[indices, ]</span>
<span id="cb44-10"><a href="gmethods2.html#cb44-10" tabindex="-1"></a>  </span>
<span id="cb44-11"><a href="gmethods2.html#cb44-11" tabindex="-1"></a>    <span class="co"># IPW</span></span>
<span id="cb44-12"><a href="gmethods2.html#cb44-12" tabindex="-1"></a>    treat_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> sex <span class="sc">+</span> age,</span>
<span id="cb44-13"><a href="gmethods2.html#cb44-13" tabindex="-1"></a>                     <span class="at">data =</span> d,</span>
<span id="cb44-14"><a href="gmethods2.html#cb44-14" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb44-15"><a href="gmethods2.html#cb44-15" tabindex="-1"></a></span>
<span id="cb44-16"><a href="gmethods2.html#cb44-16" tabindex="-1"></a>    d<span class="sc">$</span>pX <span class="ot">&lt;-</span> <span class="fu">predict</span>(treat_mod, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb44-17"><a href="gmethods2.html#cb44-17" tabindex="-1"></a></span>
<span id="cb44-18"><a href="gmethods2.html#cb44-18" tabindex="-1"></a>    pn <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb44-19"><a href="gmethods2.html#cb44-19" tabindex="-1"></a>          <span class="at">data =</span> d,</span>
<span id="cb44-20"><a href="gmethods2.html#cb44-20" tabindex="-1"></a>          <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb44-21"><a href="gmethods2.html#cb44-21" tabindex="-1"></a></span>
<span id="cb44-22"><a href="gmethods2.html#cb44-22" tabindex="-1"></a>    d<span class="sc">$</span>pnX <span class="ot">&lt;-</span> <span class="fu">predict</span>(pn, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb44-23"><a href="gmethods2.html#cb44-23" tabindex="-1"></a>  </span>
<span id="cb44-24"><a href="gmethods2.html#cb44-24" tabindex="-1"></a>    d<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">with</span>(d, <span class="fu">ifelse</span>(qsmk<span class="sc">==</span><span class="dv">1</span>, pnX<span class="sc">/</span>pX, (<span class="dv">1</span><span class="sc">-</span>pnX)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pX)))</span>
<span id="cb44-25"><a href="gmethods2.html#cb44-25" tabindex="-1"></a>    </span>
<span id="cb44-26"><a href="gmethods2.html#cb44-26" tabindex="-1"></a>    <span class="co"># G-computation with IP weighted outcome model</span></span>
<span id="cb44-27"><a href="gmethods2.html#cb44-27" tabindex="-1"></a>    out_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> sex <span class="sc">+</span> age, <span class="at">data =</span> d, <span class="at">weights =</span> sw)</span>
<span id="cb44-28"><a href="gmethods2.html#cb44-28" tabindex="-1"></a></span>
<span id="cb44-29"><a href="gmethods2.html#cb44-29" tabindex="-1"></a>    EX1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb44-30"><a href="gmethods2.html#cb44-30" tabindex="-1"></a>                   <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">1</span>))</span>
<span id="cb44-31"><a href="gmethods2.html#cb44-31" tabindex="-1"></a>  </span>
<span id="cb44-32"><a href="gmethods2.html#cb44-32" tabindex="-1"></a>    EX0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb44-33"><a href="gmethods2.html#cb44-33" tabindex="-1"></a>                   <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">0</span>))</span>
<span id="cb44-34"><a href="gmethods2.html#cb44-34" tabindex="-1"></a></span>
<span id="cb44-35"><a href="gmethods2.html#cb44-35" tabindex="-1"></a>    <span class="fu">mean</span>(EX1)<span class="sc">-</span><span class="fu">mean</span>(EX0)</span>
<span id="cb44-36"><a href="gmethods2.html#cb44-36" tabindex="-1"></a>  </span>
<span id="cb44-37"><a href="gmethods2.html#cb44-37" tabindex="-1"></a>  <span class="co"># Return the coefficient of X</span></span>
<span id="cb44-38"><a href="gmethods2.html#cb44-38" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(EX1)<span class="sc">-</span><span class="fu">mean</span>(EX0))</span>
<span id="cb44-39"><a href="gmethods2.html#cb44-39" tabindex="-1"></a>}</span>
<span id="cb44-40"><a href="gmethods2.html#cb44-40" tabindex="-1"></a></span>
<span id="cb44-41"><a href="gmethods2.html#cb44-41" tabindex="-1"></a><span class="co"># Perform bootstrapping</span></span>
<span id="cb44-42"><a href="gmethods2.html#cb44-42" tabindex="-1"></a>bootstrap_results <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> d, </span>
<span id="cb44-43"><a href="gmethods2.html#cb44-43" tabindex="-1"></a>                          <span class="at">statistic =</span> bootstrap_analysis, </span>
<span id="cb44-44"><a href="gmethods2.html#cb44-44" tabindex="-1"></a>                          <span class="at">R =</span> n_bootstrap)</span>
<span id="cb44-45"><a href="gmethods2.html#cb44-45" tabindex="-1"></a></span>
<span id="cb44-46"><a href="gmethods2.html#cb44-46" tabindex="-1"></a><span class="co"># Summarize the bootstrap results</span></span>
<span id="cb44-47"><a href="gmethods2.html#cb44-47" tabindex="-1"></a>bootstrap_summary <span class="ot">&lt;-</span> <span class="fu">boot.ci</span>(bootstrap_results, <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>)</span>
<span id="cb44-48"><a href="gmethods2.html#cb44-48" tabindex="-1"></a></span>
<span id="cb44-49"><a href="gmethods2.html#cb44-49" tabindex="-1"></a><span class="co"># Print the results</span></span>
<span id="cb44-50"><a href="gmethods2.html#cb44-50" tabindex="-1"></a><span class="fu">print</span>(bootstrap_summary)</span></code></pre></div>
<pre><code>## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 100 bootstrap replicates
## 
## CALL : 
## boot.ci(boot.out = bootstrap_results, type = &quot;norm&quot;)
## 
## Intervals : 
## Level      Normal        
## 95%   ( 2.092,  3.909 )  
## Calculations and Intervals on Original Scale</code></pre>
</div>
<div id="more-covariates" class="section level3 hasAnchor" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> More covariates<a href="gmethods2.html#more-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can try the same analysis but with a more comprehensive set of covariates.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="gmethods2.html#cb46-1" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb46-2"><a href="gmethods2.html#cb46-2" tabindex="-1"></a></span>
<span id="cb46-3"><a href="gmethods2.html#cb46-3" tabindex="-1"></a>bootstrap_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb46-4"><a href="gmethods2.html#cb46-4" tabindex="-1"></a>    </span>
<span id="cb46-5"><a href="gmethods2.html#cb46-5" tabindex="-1"></a>    <span class="co"># Resample the data</span></span>
<span id="cb46-6"><a href="gmethods2.html#cb46-6" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data[indices, ]</span>
<span id="cb46-7"><a href="gmethods2.html#cb46-7" tabindex="-1"></a>  </span>
<span id="cb46-8"><a href="gmethods2.html#cb46-8" tabindex="-1"></a>    <span class="co"># IPW</span></span>
<span id="cb46-9"><a href="gmethods2.html#cb46-9" tabindex="-1"></a>    <span class="co"># see: https://remlapmot.github.io/cibookex-r/ip-weighting-and-marginal-structural-models.html</span></span>
<span id="cb46-10"><a href="gmethods2.html#cb46-10" tabindex="-1"></a>    treat_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb46-11"><a href="gmethods2.html#cb46-11" tabindex="-1"></a>                       <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb46-12"><a href="gmethods2.html#cb46-12" tabindex="-1"></a>                       <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="gmethods2.html#cb46-13" tabindex="-1"></a>                       <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb46-14"><a href="gmethods2.html#cb46-14" tabindex="-1"></a>                     <span class="at">data =</span> d,</span>
<span id="cb46-15"><a href="gmethods2.html#cb46-15" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb46-16"><a href="gmethods2.html#cb46-16" tabindex="-1"></a></span>
<span id="cb46-17"><a href="gmethods2.html#cb46-17" tabindex="-1"></a>    d<span class="sc">$</span>pX <span class="ot">&lt;-</span> <span class="fu">predict</span>(treat_mod, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb46-18"><a href="gmethods2.html#cb46-18" tabindex="-1"></a></span>
<span id="cb46-19"><a href="gmethods2.html#cb46-19" tabindex="-1"></a>    pn <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb46-20"><a href="gmethods2.html#cb46-20" tabindex="-1"></a>          <span class="at">data =</span> d,</span>
<span id="cb46-21"><a href="gmethods2.html#cb46-21" tabindex="-1"></a>          <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb46-22"><a href="gmethods2.html#cb46-22" tabindex="-1"></a></span>
<span id="cb46-23"><a href="gmethods2.html#cb46-23" tabindex="-1"></a>    d<span class="sc">$</span>pnX <span class="ot">&lt;-</span> <span class="fu">predict</span>(pn, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb46-24"><a href="gmethods2.html#cb46-24" tabindex="-1"></a>  </span>
<span id="cb46-25"><a href="gmethods2.html#cb46-25" tabindex="-1"></a>    d<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">with</span>(d, <span class="fu">ifelse</span>(qsmk<span class="sc">==</span><span class="dv">1</span>, pnX<span class="sc">/</span>pX, (<span class="dv">1</span><span class="sc">-</span>pnX)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pX)))</span>
<span id="cb46-26"><a href="gmethods2.html#cb46-26" tabindex="-1"></a>    </span>
<span id="cb46-27"><a href="gmethods2.html#cb46-27" tabindex="-1"></a>    <span class="co"># G-computation with IP weighted outcome model</span></span>
<span id="cb46-28"><a href="gmethods2.html#cb46-28" tabindex="-1"></a>    out_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb46-29"><a href="gmethods2.html#cb46-29" tabindex="-1"></a>                       <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb46-30"><a href="gmethods2.html#cb46-30" tabindex="-1"></a>                       <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb46-31"><a href="gmethods2.html#cb46-31" tabindex="-1"></a>                       <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>), </span>
<span id="cb46-32"><a href="gmethods2.html#cb46-32" tabindex="-1"></a>                  <span class="at">data =</span> d, <span class="at">weights =</span> sw)</span>
<span id="cb46-33"><a href="gmethods2.html#cb46-33" tabindex="-1"></a></span>
<span id="cb46-34"><a href="gmethods2.html#cb46-34" tabindex="-1"></a>    EX1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb46-35"><a href="gmethods2.html#cb46-35" tabindex="-1"></a>                   <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">1</span>))</span>
<span id="cb46-36"><a href="gmethods2.html#cb46-36" tabindex="-1"></a>  </span>
<span id="cb46-37"><a href="gmethods2.html#cb46-37" tabindex="-1"></a>    EX0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, </span>
<span id="cb46-38"><a href="gmethods2.html#cb46-38" tabindex="-1"></a>                   <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">0</span>))</span>
<span id="cb46-39"><a href="gmethods2.html#cb46-39" tabindex="-1"></a></span>
<span id="cb46-40"><a href="gmethods2.html#cb46-40" tabindex="-1"></a>    <span class="fu">mean</span>(EX1)<span class="sc">-</span><span class="fu">mean</span>(EX0)</span>
<span id="cb46-41"><a href="gmethods2.html#cb46-41" tabindex="-1"></a>  </span>
<span id="cb46-42"><a href="gmethods2.html#cb46-42" tabindex="-1"></a>  <span class="co"># Return the coefficient of X</span></span>
<span id="cb46-43"><a href="gmethods2.html#cb46-43" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(EX1)<span class="sc">-</span><span class="fu">mean</span>(EX0))</span>
<span id="cb46-44"><a href="gmethods2.html#cb46-44" tabindex="-1"></a>}</span>
<span id="cb46-45"><a href="gmethods2.html#cb46-45" tabindex="-1"></a></span>
<span id="cb46-46"><a href="gmethods2.html#cb46-46" tabindex="-1"></a><span class="co"># Perform bootstrapping</span></span>
<span id="cb46-47"><a href="gmethods2.html#cb46-47" tabindex="-1"></a>bootstrap_results <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> d, </span>
<span id="cb46-48"><a href="gmethods2.html#cb46-48" tabindex="-1"></a>                          <span class="at">statistic =</span> bootstrap_analysis, </span>
<span id="cb46-49"><a href="gmethods2.html#cb46-49" tabindex="-1"></a>                          <span class="at">R =</span> n_bootstrap)</span>
<span id="cb46-50"><a href="gmethods2.html#cb46-50" tabindex="-1"></a></span>
<span id="cb46-51"><a href="gmethods2.html#cb46-51" tabindex="-1"></a><span class="co"># Summarize the bootstrap results</span></span>
<span id="cb46-52"><a href="gmethods2.html#cb46-52" tabindex="-1"></a>bootstrap_summary <span class="ot">&lt;-</span> <span class="fu">boot.ci</span>(bootstrap_results, <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>)</span>
<span id="cb46-53"><a href="gmethods2.html#cb46-53" tabindex="-1"></a></span>
<span id="cb46-54"><a href="gmethods2.html#cb46-54" tabindex="-1"></a><span class="co"># Print the results</span></span>
<span id="cb46-55"><a href="gmethods2.html#cb46-55" tabindex="-1"></a><span class="fu">print</span>(bootstrap_summary)</span></code></pre></div>
<pre><code>## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 100 bootstrap replicates
## 
## CALL : 
## boot.ci(boot.out = bootstrap_results, type = &quot;norm&quot;)
## 
## Intervals : 
## Level      Normal        
## 95%   ( 2.620,  4.393 )  
## Calculations and Intervals on Original Scale</code></pre>
<p>The overall inference is the same, although the more comprehensive adjustment set yields a slightly higher point estimate (around 3.5 kg), indicating that quitters gain even more weight than previously estimated.</p>
</div>
</div>
<div id="bootstrapped-sub-group-analysis" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Bootstrapped sub-group analysis<a href="gmethods2.html#bootstrapped-sub-group-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="gmethods2.html#cb48-1" tabindex="-1"></a>bootstrap_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb48-2"><a href="gmethods2.html#cb48-2" tabindex="-1"></a>    </span>
<span id="cb48-3"><a href="gmethods2.html#cb48-3" tabindex="-1"></a>    <span class="co"># Resample the data</span></span>
<span id="cb48-4"><a href="gmethods2.html#cb48-4" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data[indices, ]</span>
<span id="cb48-5"><a href="gmethods2.html#cb48-5" tabindex="-1"></a>  </span>
<span id="cb48-6"><a href="gmethods2.html#cb48-6" tabindex="-1"></a>    <span class="co"># IPW</span></span>
<span id="cb48-7"><a href="gmethods2.html#cb48-7" tabindex="-1"></a>    pn_sub <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> sex, <span class="at">data =</span> d, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb48-8"><a href="gmethods2.html#cb48-8" tabindex="-1"></a>    </span>
<span id="cb48-9"><a href="gmethods2.html#cb48-9" tabindex="-1"></a>    d<span class="sc">$</span>pnX <span class="ot">&lt;-</span> <span class="fu">predict</span>(pn_sub, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb48-10"><a href="gmethods2.html#cb48-10" tabindex="-1"></a>  </span>
<span id="cb48-11"><a href="gmethods2.html#cb48-11" tabindex="-1"></a>    d<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">with</span>(d, <span class="fu">ifelse</span>(qsmk <span class="sc">==</span> <span class="dv">1</span>, pnX <span class="sc">/</span> pX, (<span class="dv">1</span> <span class="sc">-</span> pnX) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pX)))</span>
<span id="cb48-12"><a href="gmethods2.html#cb48-12" tabindex="-1"></a>    </span>
<span id="cb48-13"><a href="gmethods2.html#cb48-13" tabindex="-1"></a>    <span class="co"># G-computation with IP weighted outcome model</span></span>
<span id="cb48-14"><a href="gmethods2.html#cb48-14" tabindex="-1"></a>    out_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> qsmk <span class="sc">*</span> sex, <span class="at">data =</span> d, <span class="at">weights =</span> sw)</span>
<span id="cb48-15"><a href="gmethods2.html#cb48-15" tabindex="-1"></a>    </span>
<span id="cb48-16"><a href="gmethods2.html#cb48-16" tabindex="-1"></a>    EX1S1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">1</span>, <span class="at">sex =</span> <span class="fu">as.factor</span>(<span class="dv">1</span>)))</span>
<span id="cb48-17"><a href="gmethods2.html#cb48-17" tabindex="-1"></a>    EX1S0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">1</span>, <span class="at">sex =</span> <span class="fu">as.factor</span>(<span class="dv">0</span>)))</span>
<span id="cb48-18"><a href="gmethods2.html#cb48-18" tabindex="-1"></a>    EX0S1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">0</span>, <span class="at">sex =</span> <span class="fu">as.factor</span>(<span class="dv">1</span>)))</span>
<span id="cb48-19"><a href="gmethods2.html#cb48-19" tabindex="-1"></a>    EX0S0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out_mod, <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">qsmk =</span> <span class="dv">0</span>, <span class="at">sex =</span> <span class="fu">as.factor</span>(<span class="dv">0</span>)))</span>
<span id="cb48-20"><a href="gmethods2.html#cb48-20" tabindex="-1"></a>    </span>
<span id="cb48-21"><a href="gmethods2.html#cb48-21" tabindex="-1"></a>    mean_diff_S1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(EX1S1) <span class="sc">-</span> <span class="fu">mean</span>(EX0S1)</span>
<span id="cb48-22"><a href="gmethods2.html#cb48-22" tabindex="-1"></a>    mean_diff_S0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(EX1S0) <span class="sc">-</span> <span class="fu">mean</span>(EX0S0)</span>
<span id="cb48-23"><a href="gmethods2.html#cb48-23" tabindex="-1"></a>    </span>
<span id="cb48-24"><a href="gmethods2.html#cb48-24" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(mean_diff_S1, mean_diff_S0))</span>
<span id="cb48-25"><a href="gmethods2.html#cb48-25" tabindex="-1"></a>}</span>
<span id="cb48-26"><a href="gmethods2.html#cb48-26" tabindex="-1"></a></span>
<span id="cb48-27"><a href="gmethods2.html#cb48-27" tabindex="-1"></a><span class="co"># Perform bootstrapping</span></span>
<span id="cb48-28"><a href="gmethods2.html#cb48-28" tabindex="-1"></a>bootstrap_results <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> d, <span class="at">statistic =</span> bootstrap_analysis, <span class="at">R =</span> n_bootstrap)</span>
<span id="cb48-29"><a href="gmethods2.html#cb48-29" tabindex="-1"></a></span>
<span id="cb48-30"><a href="gmethods2.html#cb48-30" tabindex="-1"></a><span class="co"># Extract and display results</span></span>
<span id="cb48-31"><a href="gmethods2.html#cb48-31" tabindex="-1"></a><span class="fu">boot.ci</span>(bootstrap_results, <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>) <span class="co"># For females</span></span></code></pre></div>
<pre><code>## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 100 bootstrap replicates
## 
## CALL : 
## boot.ci(boot.out = bootstrap_results, type = &quot;norm&quot;, index = 1)
## 
## Intervals : 
## Level      Normal        
## 95%   ( 1.619,  4.043 )  
## Calculations and Intervals on Original Scale</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="gmethods2.html#cb50-1" tabindex="-1"></a><span class="fu">boot.ci</span>(bootstrap_results, <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># For males</span></span></code></pre></div>
<pre><code>## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 100 bootstrap replicates
## 
## CALL : 
## boot.ci(boot.out = bootstrap_results, type = &quot;norm&quot;, index = 2)
## 
## Intervals : 
## Level      Normal        
## 95%   ( 2.291,  4.585 )  
## Calculations and Intervals on Original Scale</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="gmethods.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="miss.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
