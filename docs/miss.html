<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Most of Your Data is Almost Always Missing | The Data Analyst’s Guide to Cause and Effect</title>
  <meta name="description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Most of Your Data is Almost Always Missing | The Data Analyst’s Guide to Cause and Effect" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  <meta name="github-repo" content="tbendixen/DAG-companion" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Most of Your Data is Almost Always Missing | The Data Analyst’s Guide to Cause and Effect" />
  
  <meta name="twitter:description" content="The is the companion website for The Data Analyst’s Guide to Cause and Effect" />
  

<meta name="author" content="Theiss Bendixen &amp; Benjamin Grant Purzycki" />


<meta name="date" content="2024-10-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="gmethods2.html"/>
<link rel="next" href="miss2.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Data Analyst's Guide to Cause and Effect</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome!</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="dag.html"><a href="dag.html"><i class="fa fa-check"></i><b>2</b> Causal Graphs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="dag.html"><a href="dag.html#the-fork"><i class="fa fa-check"></i><b>2.1</b> The Fork</a></li>
<li class="chapter" data-level="2.2" data-path="dag.html"><a href="dag.html#the-pipe"><i class="fa fa-check"></i><b>2.2</b> The Pipe</a></li>
<li class="chapter" data-level="2.3" data-path="dag.html"><a href="dag.html#the-collider"><i class="fa fa-check"></i><b>2.3</b> The Collider</a></li>
<li class="chapter" data-level="2.4" data-path="dag.html"><a href="dag.html#post-treatment-bias"><i class="fa fa-check"></i><b>2.4</b> Post-treatment bias</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="gmethods.html"><a href="gmethods.html"><i class="fa fa-check"></i><b>3</b> G-methods and Marginal Effects</a>
<ul>
<li class="chapter" data-level="3.1" data-path="gmethods.html"><a href="gmethods.html#inverse-probability-weighting"><i class="fa fa-check"></i><b>3.1</b> Inverse probability weighting</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="gmethods.html"><a href="gmethods.html#bootstrapping"><i class="fa fa-check"></i><b>3.1.1</b> Bootstrapping</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="gmethods.html"><a href="gmethods.html#g-computation"><i class="fa fa-check"></i><b>3.2</b> G-computation</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="gmethods.html"><a href="gmethods.html#bootstrapping-1"><i class="fa fa-check"></i><b>3.2.1</b> Bootstrapping</a></li>
<li class="chapter" data-level="3.2.2" data-path="gmethods.html"><a href="gmethods.html#bayesian-g-computation"><i class="fa fa-check"></i><b>3.2.2</b> Bayesian g-computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gmethods2.html"><a href="gmethods2.html"><i class="fa fa-check"></i><b>4</b> Adventures in G-methods</a>
<ul>
<li class="chapter" data-level="4.1" data-path="gmethods2.html"><a href="gmethods2.html#doubly-robust-estimation"><i class="fa fa-check"></i><b>4.1</b> Doubly robust estimation</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="gmethods2.html"><a href="gmethods2.html#bootstrapping-2"><i class="fa fa-check"></i><b>4.1.1</b> Bootstrapping</a></li>
<li class="chapter" data-level="4.1.2" data-path="gmethods2.html"><a href="gmethods2.html#more-covariates"><i class="fa fa-check"></i><b>4.1.2</b> More covariates</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="gmethods2.html"><a href="gmethods2.html#bootstrapped-sub-group-analysis"><i class="fa fa-check"></i><b>4.2</b> Bootstrapped sub-group analysis</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="miss.html"><a href="miss.html"><i class="fa fa-check"></i><b>5</b> Most of Your Data is Almost Always Missing</a>
<ul>
<li class="chapter" data-level="5.1" data-path="miss.html"><a href="miss.html#simulating-missingness"><i class="fa fa-check"></i><b>5.1</b> Simulating missingness</a></li>
<li class="chapter" data-level="5.2" data-path="miss.html"><a href="miss.html#poststratification"><i class="fa fa-check"></i><b>5.2</b> Poststratification</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="miss.html"><a href="miss.html#frequentist-poststratification"><i class="fa fa-check"></i><b>5.2.1</b> Frequentist poststratification</a></li>
<li class="chapter" data-level="5.2.2" data-path="miss.html"><a href="miss.html#bayesian-poststratification"><i class="fa fa-check"></i><b>5.2.2</b> Bayesian poststratification</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="miss.html"><a href="miss.html#instrumental-variable-analysis"><i class="fa fa-check"></i><b>5.3</b> Instrumental variable analysis</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="miss.html"><a href="miss.html#preparing-cohen-et-al.-2015"><i class="fa fa-check"></i><b>5.3.1</b> Preparing Cohen et al. (2015)</a></li>
<li class="chapter" data-level="5.3.2" data-path="miss.html"><a href="miss.html#randomized-treatment-assignment-as-instrument"><i class="fa fa-check"></i><b>5.3.2</b> Randomized treatment assignment as instrument</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="miss.html"><a href="miss.html#bayesian-instrumental-variable-analysis"><i class="fa fa-check"></i><b>5.4</b> Bayesian instrumental variable analysis</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="miss2.html"><a href="miss2.html"><i class="fa fa-check"></i><b>6</b> More Missing Data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="miss2.html"><a href="miss2.html#simple-mean-imputation-vs.-multiple-imputation"><i class="fa fa-check"></i><b>6.1</b> Simple mean imputation vs. multiple imputation</a></li>
<li class="chapter" data-level="6.2" data-path="miss2.html"><a href="miss2.html#combine-then-predict-or-predict-then-combine"><i class="fa fa-check"></i><b>6.2</b> “Combine then predict” or “predict then combine”?</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="miss2.html"><a href="miss2.html#marginaleffects"><i class="fa fa-check"></i><b>6.2.1</b> <code>marginaleffects</code></a></li>
<li class="chapter" data-level="6.2.2" data-path="miss2.html"><a href="miss2.html#emmeans"><i class="fa fa-check"></i><b>6.2.2</b> <code>emmeans</code></a></li>
<li class="chapter" data-level="6.2.3" data-path="miss2.html"><a href="miss2.html#comparison"><i class="fa fa-check"></i><b>6.2.3</b> Comparison</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="miss2.html"><a href="miss2.html#bayesian-imputation"><i class="fa fa-check"></i><b>6.3</b> Bayesian imputation</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="advest.html"><a href="advest.html"><i class="fa fa-check"></i><b>7</b> Advanced Estimation</a>
<ul>
<li class="chapter" data-level="7.1" data-path="advest.html"><a href="advest.html#multilevel-malaria-medicine"><i class="fa fa-check"></i><b>7.1</b> Multilevel malaria medicine</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="advest.html"><a href="advest.html#naïve-model-simple-intercept-and-slope"><i class="fa fa-check"></i><b>7.1.1</b> Naïve model: Simple intercept and slope</a></li>
<li class="chapter" data-level="7.1.2" data-path="advest.html"><a href="advest.html#fixed-effects"><i class="fa fa-check"></i><b>7.1.2</b> Fixed effects</a></li>
<li class="chapter" data-level="7.1.3" data-path="advest.html"><a href="advest.html#fixed-effects-interacting-treatment-and-group"><i class="fa fa-check"></i><b>7.1.3</b> Fixed effects interacting treatment and group</a></li>
<li class="chapter" data-level="7.1.4" data-path="advest.html"><a href="advest.html#random-intercepts"><i class="fa fa-check"></i><b>7.1.4</b> Random intercepts</a></li>
<li class="chapter" data-level="7.1.5" data-path="advest.html"><a href="advest.html#random-intercepts-and-slopes"><i class="fa fa-check"></i><b>7.1.5</b> Random intercepts and slopes</a></li>
<li class="chapter" data-level="7.1.6" data-path="advest.html"><a href="advest.html#plot-models-in-a-panel"><i class="fa fa-check"></i><b>7.1.6</b> Plot models in a panel</a></li>
<li class="chapter" data-level="7.1.7" data-path="advest.html"><a href="advest.html#regularized-vs.-empirical-estimates"><i class="fa fa-check"></i><b>7.1.7</b> Regularized vs. empirical estimates</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="advest.html"><a href="advest.html#simulating-mundlak"><i class="fa fa-check"></i><b>7.2</b> Simulating Mundlak</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="advest.html"><a href="advest.html#naïve-model-ignoring-group"><i class="fa fa-check"></i><b>7.2.1</b> Naïve model (ignoring group)</a></li>
<li class="chapter" data-level="7.2.2" data-path="advest.html"><a href="advest.html#fixed-effects-1"><i class="fa fa-check"></i><b>7.2.2</b> Fixed effects</a></li>
<li class="chapter" data-level="7.2.3" data-path="advest.html"><a href="advest.html#random-intercepts-1"><i class="fa fa-check"></i><b>7.2.3</b> Random intercepts</a></li>
<li class="chapter" data-level="7.2.4" data-path="advest.html"><a href="advest.html#mundlak-model"><i class="fa fa-check"></i><b>7.2.4</b> Mundlak model</a></li>
<li class="chapter" data-level="7.2.5" data-path="advest.html"><a href="advest.html#plot-effect-estimate-distributions"><i class="fa fa-check"></i><b>7.2.5</b> Plot effect estimate distributions</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="advest.html"><a href="advest.html#education-and-prosociality-mundlak-in-action"><i class="fa fa-check"></i><b>7.3</b> Education and prosociality: Mundlak in action</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="advest.html"><a href="advest.html#raw-data-distributions"><i class="fa fa-check"></i><b>7.3.1</b> Raw data distributions</a></li>
<li class="chapter" data-level="7.3.2" data-path="advest.html"><a href="advest.html#naïve-model"><i class="fa fa-check"></i><b>7.3.2</b> Naïve model</a></li>
<li class="chapter" data-level="7.3.3" data-path="advest.html"><a href="advest.html#fixed-effects-2"><i class="fa fa-check"></i><b>7.3.3</b> Fixed effects</a></li>
<li class="chapter" data-level="7.3.4" data-path="advest.html"><a href="advest.html#random-effects"><i class="fa fa-check"></i><b>7.3.4</b> Random effects</a></li>
<li class="chapter" data-level="7.3.5" data-path="advest.html"><a href="advest.html#mundlak-model-1"><i class="fa fa-check"></i><b>7.3.5</b> Mundlak model</a></li>
<li class="chapter" data-level="7.3.6" data-path="advest.html"><a href="advest.html#plotting-effect-of-education-on-religiosity"><i class="fa fa-check"></i><b>7.3.6</b> Plotting effect of education on religiosity</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="advest.html"><a href="advest.html#marginal-effects-in-a-multilevel-model"><i class="fa fa-check"></i><b>7.4</b> Marginal effects in a multilevel model</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="advest.html"><a href="advest.html#frequentist-workflow"><i class="fa fa-check"></i><b>7.4.1</b> Frequentist workflow</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>The Data Analyst’s Guide to Cause and Effect</em></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="miss" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Most of Your Data is Almost Always Missing<a href="miss.html#miss" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="simulating-missingness" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Simulating missingness<a href="miss.html#simulating-missingness" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We first simulate informative missingness where the outcome is associated with sampling…</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="miss.html#cb52-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb52-2"><a href="miss.html#cb52-2" tabindex="-1"></a></span>
<span id="cb52-3"><a href="miss.html#cb52-3" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e3</span></span>
<span id="cb52-4"><a href="miss.html#cb52-4" tabindex="-1"></a>bX <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb52-5"><a href="miss.html#cb52-5" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb52-6"><a href="miss.html#cb52-6" tabindex="-1"></a>Y <span class="ot">&lt;-</span> bX<span class="sc">*</span>X <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">10</span>, <span class="dv">5</span>)</span>
<span id="cb52-7"><a href="miss.html#cb52-7" tabindex="-1"></a></span>
<span id="cb52-8"><a href="miss.html#cb52-8" tabindex="-1"></a>prob_missing <span class="ot">&lt;-</span> <span class="fu">plogis</span>(Y <span class="sc">-</span> <span class="fu">mean</span>(Y))</span>
<span id="cb52-9"><a href="miss.html#cb52-9" tabindex="-1"></a>miss <span class="ot">&lt;-</span> <span class="fu">runif</span>(n) <span class="sc">&lt;</span> prob_missing</span>
<span id="cb52-10"><a href="miss.html#cb52-10" tabindex="-1"></a>Y_miss <span class="ot">&lt;-</span> Y</span>
<span id="cb52-11"><a href="miss.html#cb52-11" tabindex="-1"></a>Y_miss[miss] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb52-12"><a href="miss.html#cb52-12" tabindex="-1"></a></span>
<span id="cb52-13"><a href="miss.html#cb52-13" tabindex="-1"></a>d_miss <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X =</span> X, <span class="at">Y =</span> Y, <span class="at">Y_miss =</span> Y_miss)</span></code></pre></div>
<p>… And then fit two different models: First, a model fitted only on the non-missing observations and then a model on all the data, as if we had access to the full population.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="miss.html#cb53-1" tabindex="-1"></a><span class="fu">lm</span>(Y_miss <span class="sc">~</span> X, <span class="at">data =</span> d_miss)</span>
<span id="cb53-2"><a href="miss.html#cb53-2" tabindex="-1"></a></span>
<span id="cb53-3"><a href="miss.html#cb53-3" tabindex="-1"></a><span class="fu">lm</span>(Y <span class="sc">~</span> X, <span class="at">data =</span> d_miss)</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="miss.html#cb54-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb54-2"><a href="miss.html#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="miss.html#cb54-3" tabindex="-1"></a><span class="fu">ggplot</span>(d_miss, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="miss.html#cb54-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">is.na</span>(Y_miss)), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb54-5"><a href="miss.html#cb54-5" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">data =</span> d_miss[<span class="sc">!</span><span class="fu">is.na</span>(X_miss), ]) <span class="sc">+</span></span>
<span id="cb54-6"><a href="miss.html#cb54-6" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey60&quot;</span>, <span class="at">data =</span> d_miss) <span class="sc">+</span></span>
<span id="cb54-7"><a href="miss.html#cb54-7" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;grey&quot;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>, <span class="st">&quot;Missing&quot;</span>)) <span class="sc">+</span></span>
<span id="cb54-8"><a href="miss.html#cb54-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Simulating missingness&quot;</span>,</span>
<span id="cb54-9"><a href="miss.html#cb54-9" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Models with (black) and without (grey) missingness&quot;</span>,</span>
<span id="cb54-10"><a href="miss.html#cb54-10" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;X&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Y&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-11"><a href="miss.html#cb54-11" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb54-12"><a href="miss.html#cb54-12" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): objekt &#39;X_miss&#39; blev ikke fundet</code></pre>
</div>
<div id="poststratification" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Poststratification<a href="miss.html#poststratification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To illustrate poststratification, we return to the <code>nhefs</code> dataset. We also load the US 2021 census, which will help us re-weight out model predictions to the greater US population.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="miss.html#cb56-1" tabindex="-1"></a><span class="fu">library</span>(causaldata)</span>
<span id="cb56-2"><a href="miss.html#cb56-2" tabindex="-1"></a>d <span class="ot">&lt;-</span> nhefs</span>
<span id="cb56-3"><a href="miss.html#cb56-3" tabindex="-1"></a>d<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(d<span class="sc">$</span>sex)</span>
<span id="cb56-4"><a href="miss.html#cb56-4" tabindex="-1"></a></span>
<span id="cb56-5"><a href="miss.html#cb56-5" tabindex="-1"></a>census2021 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/CensusUS2021.csv&quot;</span>)</span></code></pre></div>
<p>We then re-score the census and the <code>nhefs</code> data, such that the variable levels are consistent. We also calculate census proportions from the percentages in the original census data set.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="miss.html#cb57-1" tabindex="-1"></a>census <span class="ot">&lt;-</span> census2021</span>
<span id="cb57-2"><a href="miss.html#cb57-2" tabindex="-1"></a></span>
<span id="cb57-3"><a href="miss.html#cb57-3" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;Under 15 years&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb57-4"><a href="miss.html#cb57-4" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;15 to 17 years&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb57-5"><a href="miss.html#cb57-5" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;18 to 20 years&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb57-6"><a href="miss.html#cb57-6" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;21 to 44 years&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb57-7"><a href="miss.html#cb57-7" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;45 to 64 years&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb57-8"><a href="miss.html#cb57-8" tabindex="-1"></a>census<span class="sc">$</span>age_group[census<span class="sc">$</span>AGE_GROUP <span class="sc">==</span> <span class="st">&quot;65 years and over&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb57-9"><a href="miss.html#cb57-9" tabindex="-1"></a></span>
<span id="cb57-10"><a href="miss.html#cb57-10" tabindex="-1"></a>census<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(census<span class="sc">$</span>SEX <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb57-11"><a href="miss.html#cb57-11" tabindex="-1"></a>census<span class="sc">$</span>proportion <span class="ot">&lt;-</span> census<span class="sc">$</span>PERCENTAGE<span class="sc">/</span><span class="dv">100</span></span>
<span id="cb57-12"><a href="miss.html#cb57-12" tabindex="-1"></a></span>
<span id="cb57-13"><a href="miss.html#cb57-13" tabindex="-1"></a><span class="fu">write.csv</span>(census, <span class="st">&quot;data/census_ageGroups.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-14"><a href="miss.html#cb57-14" tabindex="-1"></a></span>
<span id="cb57-15"><a href="miss.html#cb57-15" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d</span>
<span id="cb57-16"><a href="miss.html#cb57-16" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&lt;</span> <span class="dv">15</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># &quot;Under 15 years&quot;</span></span>
<span id="cb57-17"><a href="miss.html#cb57-17" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&gt;=</span> <span class="dv">15</span> <span class="sc">&amp;</span> d2<span class="sc">$</span>age <span class="sc">&lt;=</span> <span class="dv">17</span>] <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># &quot;15 to 17 years&quot;</span></span>
<span id="cb57-18"><a href="miss.html#cb57-18" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&gt;=</span> <span class="dv">18</span> <span class="sc">&amp;</span> d2<span class="sc">$</span>age <span class="sc">&lt;=</span> <span class="dv">20</span>] <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># &quot;18 to 20 years&quot;</span></span>
<span id="cb57-19"><a href="miss.html#cb57-19" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&gt;=</span> <span class="dv">21</span> <span class="sc">&amp;</span> d2<span class="sc">$</span>age <span class="sc">&lt;=</span> <span class="dv">44</span>] <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># &quot;21 to 44 years&quot;</span></span>
<span id="cb57-20"><a href="miss.html#cb57-20" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&gt;=</span> <span class="dv">45</span> <span class="sc">&amp;</span> d2<span class="sc">$</span>age <span class="sc">&lt;=</span> <span class="dv">64</span>] <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># &quot;45 to 64 years&quot;</span></span>
<span id="cb57-21"><a href="miss.html#cb57-21" tabindex="-1"></a>d2<span class="sc">$</span>age_group[d2<span class="sc">$</span>age <span class="sc">&gt;</span> <span class="dv">64</span>] <span class="ot">&lt;-</span> <span class="dv">6</span> <span class="co"># &quot;65 years and over&quot;</span></span>
<span id="cb57-22"><a href="miss.html#cb57-22" tabindex="-1"></a></span>
<span id="cb57-23"><a href="miss.html#cb57-23" tabindex="-1"></a><span class="fu">write.csv</span>(d2, <span class="st">&quot;data/nhefs_ageGroups.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We can then check how the two datasets compare in their distributions of the covariates age and sex.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="miss.html#cb58-1" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb58-2"><a href="miss.html#cb58-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb58-3"><a href="miss.html#cb58-3" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb58-4"><a href="miss.html#cb58-4" tabindex="-1"></a></span>
<span id="cb58-5"><a href="miss.html#cb58-5" tabindex="-1"></a><span class="do">### Calculate demographic proportions in the nhefs data...</span></span>
<span id="cb58-6"><a href="miss.html#cb58-6" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="miss.html#cb58-7" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex) <span class="sc">|&gt;</span></span>
<span id="cb58-8"><a href="miss.html#cb58-8" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb58-9"><a href="miss.html#cb58-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">proportion =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb58-10"><a href="miss.html#cb58-10" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb58-11"><a href="miss.html#cb58-11" tabindex="-1"></a></span>
<span id="cb58-12"><a href="miss.html#cb58-12" tabindex="-1"></a><span class="do">### ... And fill in missing demographic combinations</span></span>
<span id="cb58-13"><a href="miss.html#cb58-13" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">data.frame</span>(<span class="at">age_group =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>), </span>
<span id="cb58-14"><a href="miss.html#cb58-14" tabindex="-1"></a>                       <span class="at">sex =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dv">3</span>),</span>
<span id="cb58-15"><a href="miss.html#cb58-15" tabindex="-1"></a>                       <span class="at">n =</span> <span class="dv">0</span>,</span>
<span id="cb58-16"><a href="miss.html#cb58-16" tabindex="-1"></a>                       <span class="at">proportion =</span> <span class="dv">0</span>),</span>
<span id="cb58-17"><a href="miss.html#cb58-17" tabindex="-1"></a>            d3)</span>
<span id="cb58-18"><a href="miss.html#cb58-18" tabindex="-1"></a></span>
<span id="cb58-19"><a href="miss.html#cb58-19" tabindex="-1"></a><span class="do">### Make age_group a factor variable</span></span>
<span id="cb58-20"><a href="miss.html#cb58-20" tabindex="-1"></a>d3<span class="sc">$</span>age_group <span class="ot">&lt;-</span> <span class="fu">factor</span>(d3<span class="sc">$</span>age_group, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb58-21"><a href="miss.html#cb58-21" tabindex="-1"></a>census<span class="sc">$</span>age_group <span class="ot">&lt;-</span> <span class="fu">factor</span>(census<span class="sc">$</span>age_group, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb58-22"><a href="miss.html#cb58-22" tabindex="-1"></a></span>
<span id="cb58-23"><a href="miss.html#cb58-23" tabindex="-1"></a><span class="do">### Plotting distributions of age groups for each sex in nhefs and census</span></span>
<span id="cb58-24"><a href="miss.html#cb58-24" tabindex="-1"></a></span>
<span id="cb58-25"><a href="miss.html#cb58-25" tabindex="-1"></a><span class="do">## Males</span></span>
<span id="cb58-26"><a href="miss.html#cb58-26" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb58-27"><a href="miss.html#cb58-27" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(d3, sex <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb58-28"><a href="miss.html#cb58-28" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> proportion, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb58-29"><a href="miss.html#cb58-29" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(census, SEX <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>),</span>
<span id="cb58-30"><a href="miss.html#cb58-30" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> PERCENTAGE<span class="sc">/</span><span class="dv">100</span>, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb58-31"><a href="miss.html#cb58-31" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb58-32"><a href="miss.html#cb58-32" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb58-33"><a href="miss.html#cb58-33" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-34"><a href="miss.html#cb58-34" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-35"><a href="miss.html#cb58-35" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-36"><a href="miss.html#cb58-36" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-37"><a href="miss.html#cb58-37" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb58-38"><a href="miss.html#cb58-38" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb58-39"><a href="miss.html#cb58-39" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb58-40"><a href="miss.html#cb58-40" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb58-41"><a href="miss.html#cb58-41" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb58-42"><a href="miss.html#cb58-42" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb58-43"><a href="miss.html#cb58-43" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb58-44"><a href="miss.html#cb58-44" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb58-45"><a href="miss.html#cb58-45" tabindex="-1"></a>                   <span class="st">&quot;6&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb58-46"><a href="miss.html#cb58-46" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Age distributions&quot;</span>,</span>
<span id="cb58-47"><a href="miss.html#cb58-47" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Males&quot;</span>)</span>
<span id="cb58-48"><a href="miss.html#cb58-48" tabindex="-1"></a></span>
<span id="cb58-49"><a href="miss.html#cb58-49" tabindex="-1"></a><span class="do">## Females</span></span>
<span id="cb58-50"><a href="miss.html#cb58-50" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb58-51"><a href="miss.html#cb58-51" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(d3, sex <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb58-52"><a href="miss.html#cb58-52" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> proportion, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb58-53"><a href="miss.html#cb58-53" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(census, SEX <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>),</span>
<span id="cb58-54"><a href="miss.html#cb58-54" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> PERCENTAGE<span class="sc">/</span><span class="dv">100</span>, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb58-55"><a href="miss.html#cb58-55" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb58-56"><a href="miss.html#cb58-56" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb58-57"><a href="miss.html#cb58-57" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-58"><a href="miss.html#cb58-58" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-59"><a href="miss.html#cb58-59" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-60"><a href="miss.html#cb58-60" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-61"><a href="miss.html#cb58-61" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb58-62"><a href="miss.html#cb58-62" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb58-63"><a href="miss.html#cb58-63" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb58-64"><a href="miss.html#cb58-64" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb58-65"><a href="miss.html#cb58-65" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb58-66"><a href="miss.html#cb58-66" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb58-67"><a href="miss.html#cb58-67" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb58-68"><a href="miss.html#cb58-68" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb58-69"><a href="miss.html#cb58-69" tabindex="-1"></a>                   <span class="st">&quot;6&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb58-70"><a href="miss.html#cb58-70" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Females&quot;</span>)</span>
<span id="cb58-71"><a href="miss.html#cb58-71" tabindex="-1"></a></span>
<span id="cb58-72"><a href="miss.html#cb58-72" tabindex="-1"></a>(p1 <span class="sc">+</span> p2)</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch5-fig-unnamed-chunk-45-1.png" width="480" /></p>
<div id="frequentist-poststratification" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Frequentist poststratification<a href="miss.html#frequentist-poststratification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We show two different poststratification implementations. First, a basic frequentist approach – see e.g. also <a href="https://github.com/RohanAlexander/mrp_workshop/blob/master/getting-started-with-mrp.Rmd" class="uri">https://github.com/RohanAlexander/mrp_workshop/blob/master/getting-started-with-mrp.Rmd</a></p>
<p>First, we fit a model on the re-scored <code>nhefs</code> data (stored in <code>d2</code>) and include interactions between the exposure <code>qsmk</code> and each of the two covariates (<code>sex</code> and <code>age&gt;_group</code>) to make the model reasonably flexible.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="miss.html#cb59-1" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk<span class="sc">*</span>sex <span class="sc">+</span> qsmk<span class="sc">*</span>age_group, </span>
<span id="cb59-2"><a href="miss.html#cb59-2" tabindex="-1"></a>          <span class="at">data =</span> d2)</span></code></pre></div>
<p>We then apply g-computation with a twist. The twist is that we use the model fitted on <code>nhefs</code> data to get potential outcomes predictions (<span class="math inline">\(Y^{X=1}\)</span> and <span class="math inline">\(Y^{X=0}\)</span>) for the <code>census</code> data frame and then weight our predictions with the demographic proportions of each combination of sex and age group in the greater US population according to the census. We finally calculate the difference in means between the weighted predictions to get a marginal effect estimate, which we find to be around 7 kg. Before we can do any of it, however, we need to make sure that <code>age_group</code> is treated as numeric and <code>sex</code> as a factor, since this was the variable types used for model fitting.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="miss.html#cb60-1" tabindex="-1"></a>census<span class="sc">$</span>age_group <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(census<span class="sc">$</span>age_group)</span>
<span id="cb60-2"><a href="miss.html#cb60-2" tabindex="-1"></a>census<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(census<span class="sc">$</span>sex)</span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="miss.html#cb61-1" tabindex="-1"></a>census<span class="sc">$</span>EX1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod,</span>
<span id="cb61-2"><a href="miss.html#cb61-2" tabindex="-1"></a>                      <span class="at">newdata =</span> <span class="fu">transform</span>(census, </span>
<span id="cb61-3"><a href="miss.html#cb61-3" tabindex="-1"></a>                                          <span class="at">qsmk =</span> <span class="dv">1</span>))</span>
<span id="cb61-4"><a href="miss.html#cb61-4" tabindex="-1"></a></span>
<span id="cb61-5"><a href="miss.html#cb61-5" tabindex="-1"></a>census<span class="sc">$</span>EX0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, </span>
<span id="cb61-6"><a href="miss.html#cb61-6" tabindex="-1"></a>                      <span class="at">newdata =</span> <span class="fu">transform</span>(census, </span>
<span id="cb61-7"><a href="miss.html#cb61-7" tabindex="-1"></a>                                          <span class="at">qsmk =</span> <span class="dv">0</span>))</span>
<span id="cb61-8"><a href="miss.html#cb61-8" tabindex="-1"></a></span>
<span id="cb61-9"><a href="miss.html#cb61-9" tabindex="-1"></a>census<span class="sc">$</span>wEX1 <span class="ot">&lt;-</span> census<span class="sc">$</span>EX1<span class="sc">*</span>census<span class="sc">$</span>proportion</span>
<span id="cb61-10"><a href="miss.html#cb61-10" tabindex="-1"></a></span>
<span id="cb61-11"><a href="miss.html#cb61-11" tabindex="-1"></a>census<span class="sc">$</span>wEX0 <span class="ot">&lt;-</span> census<span class="sc">$</span>EX0<span class="sc">*</span>census<span class="sc">$</span>proportion</span>
<span id="cb61-12"><a href="miss.html#cb61-12" tabindex="-1"></a></span>
<span id="cb61-13"><a href="miss.html#cb61-13" tabindex="-1"></a><span class="fu">with</span>(census, <span class="fu">sum</span>(wEX1)<span class="sc">-</span><span class="fu">sum</span>(wEX0))</span></code></pre></div>
<pre><code>## [1] 6.991724</code></pre>
<p>Here’s the code to reproduce the accompanying table in the text.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="miss.html#cb63-1" tabindex="-1"></a>xtable<span class="sc">::</span><span class="fu">xtable</span>(census[<span class="fu">c</span>(<span class="st">&quot;AGE_GROUP&quot;</span>, <span class="st">&quot;SEX&quot;</span>, <span class="st">&quot;EX1&quot;</span>, <span class="st">&quot;EX0&quot;</span>,<span class="st">&quot;wEX1&quot;</span>, <span class="st">&quot;wEX0&quot;</span>)], </span>
<span id="cb63-2"><a href="miss.html#cb63-2" tabindex="-1"></a>               <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">include.rownames=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## % latex table generated in R 4.4.0 by xtable 1.8-4 package
## % Sat Oct 19 00:10:44 2024
## \begin{table}[ht]
## \centering
## \begin{tabular}{rllrrrr}
##   \hline
##  &amp; AGE\_GROUP &amp; SEX &amp; EX1 &amp; EX0 &amp; wEX1 &amp; wEX0 \\ 
##   \hline
## 1 &amp; Under 15 years &amp; MALE &amp; 19.4 &amp; 13.1 &amp; 3.7 &amp; 2.5 \\ 
##   2 &amp; 15 to 17 years &amp; MALE &amp; 15.4 &amp; 10.0 &amp; 0.6 &amp; 0.4 \\ 
##   3 &amp; 18 to 20 years &amp; MALE &amp; 11.5 &amp; 6.8 &amp; 0.4 &amp; 0.3 \\ 
##   4 &amp; 21 to 44 years &amp; MALE &amp; 7.5 &amp; 3.7 &amp; 2.4 &amp; 1.2 \\ 
##   5 &amp; 45 to 64 years &amp; MALE &amp; 3.6 &amp; 0.5 &amp; 0.9 &amp; 0.1 \\ 
##   6 &amp; 65 years and over &amp; MALE &amp; -0.4 &amp; -2.6 &amp; -0.1 &amp; -0.4 \\ 
##   7 &amp; Under 15 years &amp; FEMALE &amp; 18.3 &amp; 12.9 &amp; 3.2 &amp; 2.3 \\ 
##   8 &amp; 15 to 17 years &amp; FEMALE &amp; 14.4 &amp; 9.7 &amp; 0.5 &amp; 0.4 \\ 
##   9 &amp; 18 to 20 years &amp; FEMALE &amp; 10.4 &amp; 6.6 &amp; 0.4 &amp; 0.2 \\ 
##   10 &amp; 21 to 44 years &amp; FEMALE &amp; 6.5 &amp; 3.4 &amp; 2.0 &amp; 1.1 \\ 
##   11 &amp; 45 to 64 years &amp; FEMALE &amp; 2.5 &amp; 0.3 &amp; 0.6 &amp; 0.1 \\ 
##   12 &amp; 65 years and over &amp; FEMALE &amp; -1.5 &amp; -2.9 &amp; -0.3 &amp; -0.5 \\ 
##    \hline
## \end{tabular}
## \end{table}</code></pre>
</div>
<div id="bayesian-poststratification" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Bayesian poststratification<a href="miss.html#bayesian-poststratification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We finally show a fully Bayesian poststratification routine. To showcase the difference between a single-level (i.e., fixed effects) and a multilevel (i.e., random effects) model for poststratification, we fit a Bayesian multilevel model and contrast that with the frequentist model predictions stored in <code>census</code>. For fitting, we again use the <code>brms</code> package with default priors and a seed for reproducibility. We allow the effect of the exposure <code>qsmk</code> vary within both <code>sex</code> and <code>age_group</code> using common <code>R</code> formula syntax.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="miss.html#cb65-1" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb65-2"><a href="miss.html#cb65-2" tabindex="-1"></a></span>
<span id="cb65-3"><a href="miss.html#cb65-3" tabindex="-1"></a>bayes_mod <span class="ot">&lt;-</span> <span class="fu">brm</span>(wt82_71 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> qsmk <span class="sc">|</span> sex) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> qsmk <span class="sc">|</span> age_group), </span>
<span id="cb65-4"><a href="miss.html#cb65-4" tabindex="-1"></a>                 <span class="at">data =</span> d2, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">42</span>, </span>
<span id="cb65-5"><a href="miss.html#cb65-5" tabindex="-1"></a>                 <span class="at">file =</span> <span class="st">&quot;fits/bayes_poststrat&quot;</span>)</span></code></pre></div>
<p>Next, we do two things with this model. First, we compute the posterior mean predictions for each covariate combination without applying poststratification.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="miss.html#cb66-1" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb66-2"><a href="miss.html#cb66-2" tabindex="-1"></a></span>
<span id="cb66-3"><a href="miss.html#cb66-3" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 1 for all</span></span>
<span id="cb66-4"><a href="miss.html#cb66-4" tabindex="-1"></a>psEX1 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod, </span>
<span id="cb66-5"><a href="miss.html#cb66-5" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">1</span>),</span>
<span id="cb66-6"><a href="miss.html#cb66-6" tabindex="-1"></a>                         <span class="co"># Predict for covariates combinations </span></span>
<span id="cb66-7"><a href="miss.html#cb66-7" tabindex="-1"></a>                         <span class="co"># not observed in the training data (nhefs)</span></span>
<span id="cb66-8"><a href="miss.html#cb66-8" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-9"><a href="miss.html#cb66-9" tabindex="-1"></a>  <span class="co"># Posterior means for each covariate combination</span></span>
<span id="cb66-10"><a href="miss.html#cb66-10" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex) <span class="sc">|&gt;</span> </span>
<span id="cb66-11"><a href="miss.html#cb66-11" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">psEX1 =</span> <span class="fu">mean</span>(.epred))</span>
<span id="cb66-12"><a href="miss.html#cb66-12" tabindex="-1"></a></span>
<span id="cb66-13"><a href="miss.html#cb66-13" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 0 for all</span></span>
<span id="cb66-14"><a href="miss.html#cb66-14" tabindex="-1"></a>psEX0 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod, </span>
<span id="cb66-15"><a href="miss.html#cb66-15" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">0</span>),</span>
<span id="cb66-16"><a href="miss.html#cb66-16" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-17"><a href="miss.html#cb66-17" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex) <span class="sc">|&gt;</span> </span>
<span id="cb66-18"><a href="miss.html#cb66-18" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">psEX0 =</span> <span class="fu">mean</span>(.epred))</span></code></pre></div>
<p>Then, we again compute the marginal mean predictions for each covariate combination but this time applying poststratification weights. Everything else is the same.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="miss.html#cb67-1" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 1 for all</span></span>
<span id="cb67-2"><a href="miss.html#cb67-2" tabindex="-1"></a>wpsEX1 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod,</span>
<span id="cb67-3"><a href="miss.html#cb67-3" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">1</span>),</span>
<span id="cb67-4"><a href="miss.html#cb67-4" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-5"><a href="miss.html#cb67-5" tabindex="-1"></a>  <span class="co"># New bit: Re-weight model predictions using census proportions</span></span>
<span id="cb67-6"><a href="miss.html#cb67-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate_prop =</span> .epred<span class="sc">*</span>proportion) <span class="sc">|&gt;</span></span>
<span id="cb67-7"><a href="miss.html#cb67-7" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex, .draw) <span class="sc">|&gt;</span></span>
<span id="cb67-8"><a href="miss.html#cb67-8" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wpsEX1 =</span> <span class="fu">sum</span>(estimate_prop)) <span class="sc">|&gt;</span></span>
<span id="cb67-9"><a href="miss.html#cb67-9" tabindex="-1"></a>  <span class="co"># Posterior means for each covariate combination</span></span>
<span id="cb67-10"><a href="miss.html#cb67-10" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex) <span class="sc">|&gt;</span></span>
<span id="cb67-11"><a href="miss.html#cb67-11" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wpsEX1 =</span> <span class="fu">mean</span>(wpsEX1))</span>
<span id="cb67-12"><a href="miss.html#cb67-12" tabindex="-1"></a></span>
<span id="cb67-13"><a href="miss.html#cb67-13" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 0 for all</span></span>
<span id="cb67-14"><a href="miss.html#cb67-14" tabindex="-1"></a>wpsEX0 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod,</span>
<span id="cb67-15"><a href="miss.html#cb67-15" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">0</span>),</span>
<span id="cb67-16"><a href="miss.html#cb67-16" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-17"><a href="miss.html#cb67-17" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate_prop =</span> .epred<span class="sc">*</span>proportion) <span class="sc">|&gt;</span></span>
<span id="cb67-18"><a href="miss.html#cb67-18" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex, .draw) <span class="sc">|&gt;</span></span>
<span id="cb67-19"><a href="miss.html#cb67-19" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wpsEX0 =</span> <span class="fu">sum</span>(estimate_prop)) <span class="sc">|&gt;</span></span>
<span id="cb67-20"><a href="miss.html#cb67-20" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, sex) <span class="sc">|&gt;</span></span>
<span id="cb67-21"><a href="miss.html#cb67-21" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wpsEX0 =</span> <span class="fu">mean</span>(wpsEX0))</span></code></pre></div>
<p>We then collect the posterior mean predictions and the frequentist predictions in two data frames, without and with poststratification…</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="miss.html#cb68-1" tabindex="-1"></a><span class="do">### No poststratification</span></span>
<span id="cb68-2"><a href="miss.html#cb68-2" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age_group =</span> census<span class="sc">$</span>AGE_GROUP,</span>
<span id="cb68-3"><a href="miss.html#cb68-3" tabindex="-1"></a>                 <span class="at">sex =</span> census<span class="sc">$</span>SEX,</span>
<span id="cb68-4"><a href="miss.html#cb68-4" tabindex="-1"></a>                 <span class="at">EX1 =</span> census<span class="sc">$</span>EX1,</span>
<span id="cb68-5"><a href="miss.html#cb68-5" tabindex="-1"></a>                 <span class="at">EX0 =</span> census<span class="sc">$</span>EX0,</span>
<span id="cb68-6"><a href="miss.html#cb68-6" tabindex="-1"></a>                 <span class="at">psEX1 =</span> psEX1<span class="sc">$</span>psEX1,</span>
<span id="cb68-7"><a href="miss.html#cb68-7" tabindex="-1"></a>                 <span class="at">psEX0 =</span> psEX0<span class="sc">$</span>psEX0,</span>
<span id="cb68-8"><a href="miss.html#cb68-8" tabindex="-1"></a>                 <span class="at">E =</span> census<span class="sc">$</span>EX1 <span class="sc">-</span> census<span class="sc">$</span>EX0,</span>
<span id="cb68-9"><a href="miss.html#cb68-9" tabindex="-1"></a>                 <span class="at">psE =</span> psEX1<span class="sc">$</span>psEX1 <span class="sc">-</span> psEX0<span class="sc">$</span>psEX0)</span>
<span id="cb68-10"><a href="miss.html#cb68-10" tabindex="-1"></a></span>
<span id="cb68-11"><a href="miss.html#cb68-11" tabindex="-1"></a>ps<span class="sc">$</span>age_group <span class="ot">&lt;-</span> <span class="fu">factor</span>(ps<span class="sc">$</span>age_group, <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb68-12"><a href="miss.html#cb68-12" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb68-13"><a href="miss.html#cb68-13" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb68-14"><a href="miss.html#cb68-14" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb68-15"><a href="miss.html#cb68-15" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb68-16"><a href="miss.html#cb68-16" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb68-17"><a href="miss.html#cb68-17" tabindex="-1"></a>                   <span class="st">&quot;6&quot;</span> <span class="ot">=</span> <span class="st">&quot;65 years and over&quot;</span>))</span>
<span id="cb68-18"><a href="miss.html#cb68-18" tabindex="-1"></a></span>
<span id="cb68-19"><a href="miss.html#cb68-19" tabindex="-1"></a><span class="do">### With poststratification</span></span>
<span id="cb68-20"><a href="miss.html#cb68-20" tabindex="-1"></a>psw <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age_group =</span> census<span class="sc">$</span>AGE_GROUP,</span>
<span id="cb68-21"><a href="miss.html#cb68-21" tabindex="-1"></a>                 <span class="at">sex =</span> census<span class="sc">$</span>SEX,</span>
<span id="cb68-22"><a href="miss.html#cb68-22" tabindex="-1"></a>                 <span class="at">wEX1 =</span> census<span class="sc">$</span>wEX1,</span>
<span id="cb68-23"><a href="miss.html#cb68-23" tabindex="-1"></a>                 <span class="at">wEX0 =</span> census<span class="sc">$</span>wEX0,</span>
<span id="cb68-24"><a href="miss.html#cb68-24" tabindex="-1"></a>                 <span class="at">wpsEX1 =</span> wpsEX1<span class="sc">$</span>wpsEX1,</span>
<span id="cb68-25"><a href="miss.html#cb68-25" tabindex="-1"></a>                 <span class="at">wpsEX0 =</span> wpsEX0<span class="sc">$</span>wpsEX0)</span>
<span id="cb68-26"><a href="miss.html#cb68-26" tabindex="-1"></a></span>
<span id="cb68-27"><a href="miss.html#cb68-27" tabindex="-1"></a>psw<span class="sc">$</span>age_group <span class="ot">&lt;-</span> <span class="fu">factor</span>(psw<span class="sc">$</span>age_group, <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb68-28"><a href="miss.html#cb68-28" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb68-29"><a href="miss.html#cb68-29" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb68-30"><a href="miss.html#cb68-30" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb68-31"><a href="miss.html#cb68-31" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb68-32"><a href="miss.html#cb68-32" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb68-33"><a href="miss.html#cb68-33" tabindex="-1"></a>                   <span class="st">&quot;6&quot;</span> <span class="ot">=</span> <span class="st">&quot;65 years and over&quot;</span>))</span></code></pre></div>
<p>… And plot the comparisons.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="miss.html#cb69-1" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb69-2"><a href="miss.html#cb69-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>), </span>
<span id="cb69-3"><a href="miss.html#cb69-3" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> EX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb69-4"><a href="miss.html#cb69-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>),</span>
<span id="cb69-5"><a href="miss.html#cb69-5" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> psEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-6"><a href="miss.html#cb69-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>), </span>
<span id="cb69-7"><a href="miss.html#cb69-7" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> EX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb69-8"><a href="miss.html#cb69-8" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>),</span>
<span id="cb69-9"><a href="miss.html#cb69-9" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> psEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-10"><a href="miss.html#cb69-10" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb69-11"><a href="miss.html#cb69-11" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Weight change (kg)&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-12"><a href="miss.html#cb69-12" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb69-13"><a href="miss.html#cb69-13" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb69-14"><a href="miss.html#cb69-14" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb69-15"><a href="miss.html#cb69-15" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb69-16"><a href="miss.html#cb69-16" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb69-17"><a href="miss.html#cb69-17" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb69-18"><a href="miss.html#cb69-18" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb69-19"><a href="miss.html#cb69-19" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb69-20"><a href="miss.html#cb69-20" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb69-21"><a href="miss.html#cb69-21" tabindex="-1"></a>                   <span class="st">&quot;65 years and over&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb69-22"><a href="miss.html#cb69-22" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Predicted weight change&quot;</span>,</span>
<span id="cb69-23"><a href="miss.html#cb69-23" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;No poststratification&quot;</span>)</span>
<span id="cb69-24"><a href="miss.html#cb69-24" tabindex="-1"></a></span>
<span id="cb69-25"><a href="miss.html#cb69-25" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb69-26"><a href="miss.html#cb69-26" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>), </span>
<span id="cb69-27"><a href="miss.html#cb69-27" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb69-28"><a href="miss.html#cb69-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>),</span>
<span id="cb69-29"><a href="miss.html#cb69-29" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wpsEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-30"><a href="miss.html#cb69-30" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>), </span>
<span id="cb69-31"><a href="miss.html#cb69-31" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb69-32"><a href="miss.html#cb69-32" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;FEMALE&quot;</span>),</span>
<span id="cb69-33"><a href="miss.html#cb69-33" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wpsEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-34"><a href="miss.html#cb69-34" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb69-35"><a href="miss.html#cb69-35" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb69-36"><a href="miss.html#cb69-36" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb69-37"><a href="miss.html#cb69-37" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb69-38"><a href="miss.html#cb69-38" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb69-39"><a href="miss.html#cb69-39" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb69-40"><a href="miss.html#cb69-40" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb69-41"><a href="miss.html#cb69-41" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb69-42"><a href="miss.html#cb69-42" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb69-43"><a href="miss.html#cb69-43" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb69-44"><a href="miss.html#cb69-44" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb69-45"><a href="miss.html#cb69-45" tabindex="-1"></a>                   <span class="st">&quot;65 years and over&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb69-46"><a href="miss.html#cb69-46" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;With poststratification&quot;</span>)</span>
<span id="cb69-47"><a href="miss.html#cb69-47" tabindex="-1"></a></span>
<span id="cb69-48"><a href="miss.html#cb69-48" tabindex="-1"></a>(p1 <span class="sc">+</span> p2)</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch5-fig-unnamed-chunk-55-1.png" width="480" /></p>
<p>In the text, we showed predictions for females only, but the results are similar for males.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="miss.html#cb70-1" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb70-2"><a href="miss.html#cb70-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>), </span>
<span id="cb70-3"><a href="miss.html#cb70-3" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> EX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb70-4"><a href="miss.html#cb70-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>),</span>
<span id="cb70-5"><a href="miss.html#cb70-5" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> psEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb70-6"><a href="miss.html#cb70-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>), </span>
<span id="cb70-7"><a href="miss.html#cb70-7" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> EX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb70-8"><a href="miss.html#cb70-8" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(ps, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>),</span>
<span id="cb70-9"><a href="miss.html#cb70-9" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> psEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb70-10"><a href="miss.html#cb70-10" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb70-11"><a href="miss.html#cb70-11" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Weight change (kg)&quot;</span>) <span class="sc">+</span></span>
<span id="cb70-12"><a href="miss.html#cb70-12" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb70-13"><a href="miss.html#cb70-13" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb70-14"><a href="miss.html#cb70-14" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb70-15"><a href="miss.html#cb70-15" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb70-16"><a href="miss.html#cb70-16" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb70-17"><a href="miss.html#cb70-17" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb70-18"><a href="miss.html#cb70-18" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb70-19"><a href="miss.html#cb70-19" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb70-20"><a href="miss.html#cb70-20" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb70-21"><a href="miss.html#cb70-21" tabindex="-1"></a>                   <span class="st">&quot;65 years and over&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb70-22"><a href="miss.html#cb70-22" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Predicted weight change&quot;</span>,</span>
<span id="cb70-23"><a href="miss.html#cb70-23" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;No poststratification (males)&quot;</span>)</span>
<span id="cb70-24"><a href="miss.html#cb70-24" tabindex="-1"></a></span>
<span id="cb70-25"><a href="miss.html#cb70-25" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb70-26"><a href="miss.html#cb70-26" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>), </span>
<span id="cb70-27"><a href="miss.html#cb70-27" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb70-28"><a href="miss.html#cb70-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>),</span>
<span id="cb70-29"><a href="miss.html#cb70-29" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wpsEX1, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb70-30"><a href="miss.html#cb70-30" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>), </span>
<span id="cb70-31"><a href="miss.html#cb70-31" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb70-32"><a href="miss.html#cb70-32" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(psw, sex <span class="sc">==</span> <span class="st">&quot;MALE&quot;</span>),</span>
<span id="cb70-33"><a href="miss.html#cb70-33" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> age_group, <span class="at">y =</span> wpsEX0, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb70-34"><a href="miss.html#cb70-34" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb70-35"><a href="miss.html#cb70-35" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb70-36"><a href="miss.html#cb70-36" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb70-37"><a href="miss.html#cb70-37" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">60</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb70-38"><a href="miss.html#cb70-38" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, </span>
<span id="cb70-39"><a href="miss.html#cb70-39" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb70-40"><a href="miss.html#cb70-40" tabindex="-1"></a>                   <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Under 15 years&quot;</span>,</span>
<span id="cb70-41"><a href="miss.html#cb70-41" tabindex="-1"></a>                   <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;15 to 17 years&quot;</span>,</span>
<span id="cb70-42"><a href="miss.html#cb70-42" tabindex="-1"></a>                   <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;18 to 20 years&quot;</span>,</span>
<span id="cb70-43"><a href="miss.html#cb70-43" tabindex="-1"></a>                   <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;21 to 44 years&quot;</span>,</span>
<span id="cb70-44"><a href="miss.html#cb70-44" tabindex="-1"></a>                   <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;45 to 64 years&quot;</span>,</span>
<span id="cb70-45"><a href="miss.html#cb70-45" tabindex="-1"></a>                   <span class="st">&quot;65 years and over&quot;</span> <span class="ot">=</span> <span class="st">&quot;+65 years&quot;</span>)) <span class="sc">+</span></span>
<span id="cb70-46"><a href="miss.html#cb70-46" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;With poststratification (males)&quot;</span>)</span>
<span id="cb70-47"><a href="miss.html#cb70-47" tabindex="-1"></a></span>
<span id="cb70-48"><a href="miss.html#cb70-48" tabindex="-1"></a>(p3 <span class="sc">+</span> p4)</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch5-fig-unnamed-chunk-56-1.png" width="480" /></p>
<div id="poststratified-marginal-causal-effect" class="section level4 hasAnchor" number="5.2.2.1">
<h4><span class="header-section-number">5.2.2.1</span> Poststratified marginal causal effect<a href="miss.html#poststratified-marginal-causal-effect" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The above workflow computed and plotted posterior means, but with a Bayesian model we have a full posterior distribution to work with. So let’s do that. This time, we’re interested in the poststratified estimate for the population <em>as a whole</em>. This means that we have to marginalize over the covariates, which we do by grouping on posterior draws instead of on the covariates. The rest should look familiar.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="miss.html#cb71-1" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 1 for all</span></span>
<span id="cb71-2"><a href="miss.html#cb71-2" tabindex="-1"></a>ateEX1 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod,</span>
<span id="cb71-3"><a href="miss.html#cb71-3" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">1</span>),</span>
<span id="cb71-4"><a href="miss.html#cb71-4" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-5"><a href="miss.html#cb71-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate_prop =</span> .epred<span class="sc">*</span>proportion) <span class="sc">|&gt;</span></span>
<span id="cb71-6"><a href="miss.html#cb71-6" tabindex="-1"></a>  <span class="co"># New bit: Marginalize over covariate combinations by grouping on .draw</span></span>
<span id="cb71-7"><a href="miss.html#cb71-7" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw) <span class="sc">|&gt;</span></span>
<span id="cb71-8"><a href="miss.html#cb71-8" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.epred =</span> <span class="fu">sum</span>(estimate_prop))</span>
<span id="cb71-9"><a href="miss.html#cb71-9" tabindex="-1"></a></span>
<span id="cb71-10"><a href="miss.html#cb71-10" tabindex="-1"></a><span class="do">### Predict outcome when exposure X = 1 for all</span></span>
<span id="cb71-11"><a href="miss.html#cb71-11" tabindex="-1"></a>ateEX0 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_mod,</span>
<span id="cb71-12"><a href="miss.html#cb71-12" tabindex="-1"></a>                         <span class="at">newdata =</span> <span class="fu">transform</span>(census, <span class="at">qsmk=</span><span class="dv">0</span>),</span>
<span id="cb71-13"><a href="miss.html#cb71-13" tabindex="-1"></a>                         <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-14"><a href="miss.html#cb71-14" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate_prop =</span> .epred<span class="sc">*</span>proportion) <span class="sc">|&gt;</span></span>
<span id="cb71-15"><a href="miss.html#cb71-15" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw) <span class="sc">|&gt;</span></span>
<span id="cb71-16"><a href="miss.html#cb71-16" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.epred =</span> <span class="fu">sum</span>(estimate_prop))</span>
<span id="cb71-17"><a href="miss.html#cb71-17" tabindex="-1"></a></span>
<span id="cb71-18"><a href="miss.html#cb71-18" tabindex="-1"></a><span class="do">### Compute poststratified ATE</span></span>
<span id="cb71-19"><a href="miss.html#cb71-19" tabindex="-1"></a>poststratified_ate <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EX1 =</span> ateEX1<span class="sc">$</span>.epred,</span>
<span id="cb71-20"><a href="miss.html#cb71-20" tabindex="-1"></a>                                 <span class="at">EX0 =</span> ateEX0<span class="sc">$</span>.epred,</span>
<span id="cb71-21"><a href="miss.html#cb71-21" tabindex="-1"></a>                                 <span class="at">draw =</span> ateEX0<span class="sc">$</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb71-22"><a href="miss.html#cb71-22" tabindex="-1"></a>  <span class="co"># For each posterior draw...</span></span>
<span id="cb71-23"><a href="miss.html#cb71-23" tabindex="-1"></a>  <span class="fu">group_by</span>(draw) <span class="sc">|&gt;</span></span>
<span id="cb71-24"><a href="miss.html#cb71-24" tabindex="-1"></a>  <span class="co"># ... Calculate ATE</span></span>
<span id="cb71-25"><a href="miss.html#cb71-25" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ate =</span> <span class="fu">mean</span>(EX1 <span class="sc">-</span> EX0))</span></code></pre></div>
<p>The poststratified marginal causal effect is around 4.7 kg but with a fairly wide 95% interval ranging from around 0 to 9 kg.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="miss.html#cb72-1" tabindex="-1"></a><span class="fu">mean_hdi</span>(poststratified_ate<span class="sc">$</span>ate)</span></code></pre></div>
<pre><code>##          y      ymin     ymax .width .point .interval
## 1 4.677918 0.1554798 8.870636   0.95   mean       hdi</code></pre>
<p>Behold the full posterior poststratified marginal causal effect!</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="miss.html#cb74-1" tabindex="-1"></a><span class="fu">ggplot</span>(poststratified_ate, <span class="fu">aes</span>(<span class="at">x =</span> ate)) <span class="sc">+</span></span>
<span id="cb74-2"><a href="miss.html#cb74-2" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb74-3"><a href="miss.html#cb74-3" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="bookdown-dag_files/figure-html/ch5-fig-unnamed-chunk-59-1.png" width="480" /></p>
</div>
</div>
</div>
<div id="instrumental-variable-analysis" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Instrumental variable analysis<a href="miss.html#instrumental-variable-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="preparing-cohen-et-al.-2015" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Preparing Cohen et al. (2015)<a href="miss.html#preparing-cohen-et-al.-2015" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll use the data <code>ACT_IllLvlMainWithMalProbs_FINAL_pub.dta</code> from Cohen et al. (2015), which can be downloaded from the book’s <a href="https://github.com/tbendixen/DAG-companion/tree/main/docs">Github page</a> or <a href="https://www.openicpsr.org/openicpsr/project/112911/version/V1/view?path=/openicpsr/112911/fcr:versions/V1/AER2013-0267_data-code&amp;type=folder">www.openicpsr.org</a>.</p>
<p>The data need to be wrangled a little before use. Each row is an illness period, where most households only have a single illness period. A few households, however, do have more. The models we use here assume – as did the original study – illness periods to be independent.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="miss.html#cb75-1" tabindex="-1"></a><span class="fu">library</span>(haven) <span class="co"># for loading .dta file</span></span>
<span id="cb75-2"><a href="miss.html#cb75-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb75-3"><a href="miss.html#cb75-3" tabindex="-1"></a></span>
<span id="cb75-4"><a href="miss.html#cb75-4" tabindex="-1"></a><span class="do">### Load original data</span></span>
<span id="cb75-5"><a href="miss.html#cb75-5" tabindex="-1"></a>dta <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">&quot;data/ACT_IllLvlMainWithMalProbs_FINAL_pub.dta&quot;</span>) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb75-6"><a href="miss.html#cb75-6" tabindex="-1"></a></span>
<span id="cb75-7"><a href="miss.html#cb75-7" tabindex="-1"></a><span class="do">### Filter data set, as the original study did -- re-use name from original analysis script</span></span>
<span id="cb75-8"><a href="miss.html#cb75-8" tabindex="-1"></a>all_ill_prob <span class="ot">&lt;-</span> <span class="fu">subset</span>(dta, first_ep<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> ex_post<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> rdt_any<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb75-9"><a href="miss.html#cb75-9" tabindex="-1"></a></span>
<span id="cb75-10"><a href="miss.html#cb75-10" tabindex="-1"></a><span class="do">### Collaps all ACT subsidy types</span></span>
<span id="cb75-11"><a href="miss.html#cb75-11" tabindex="-1"></a>all_ill_prob<span class="sc">$</span>act_any <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(all_ill_prob<span class="sc">$</span>act40<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> </span>
<span id="cb75-12"><a href="miss.html#cb75-12" tabindex="-1"></a>                                 all_ill_prob<span class="sc">$</span>act60<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> </span>
<span id="cb75-13"><a href="miss.html#cb75-13" tabindex="-1"></a>                                 all_ill_prob<span class="sc">$</span>act100<span class="sc">==</span><span class="dv">1</span>, </span>
<span id="cb75-14"><a href="miss.html#cb75-14" tabindex="-1"></a>                               <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb75-15"><a href="miss.html#cb75-15" tabindex="-1"></a></span>
<span id="cb75-16"><a href="miss.html#cb75-16" tabindex="-1"></a><span class="do">### Replace sample-mean imputed values with NAs to allow Bayesian imputation, and then standardize </span></span>
<span id="cb75-17"><a href="miss.html#cb75-17" tabindex="-1"></a>all_ill_prob<span class="sc">$</span>B_head_age_bimps <span class="ot">&lt;-</span> <span class="fu">with</span>(all_ill_prob, </span>
<span id="cb75-18"><a href="miss.html#cb75-18" tabindex="-1"></a>                                      <span class="fu">ifelse</span>(B_head_age_missing<span class="sc">==</span><span class="dv">1</span>, <span class="cn">NA</span>, B_head_age_imputed))</span>
<span id="cb75-19"><a href="miss.html#cb75-19" tabindex="-1"></a></span>
<span id="cb75-20"><a href="miss.html#cb75-20" tabindex="-1"></a><span class="do">### Prepare data for IV and multilevel analysis</span></span>
<span id="cb75-21"><a href="miss.html#cb75-21" tabindex="-1"></a>cohen2015 <span class="ot">&lt;-</span> all_ill_prob <span class="sc">|&gt;</span></span>
<span id="cb75-22"><a href="miss.html#cb75-22" tabindex="-1"></a>  <span class="fu">select</span>(householdid, took_act, act_any, B_head_age_bimps, head_lit, used_act_v, totstrata)</span>
<span id="cb75-23"><a href="miss.html#cb75-23" tabindex="-1"></a></span>
<span id="cb75-24"><a href="miss.html#cb75-24" tabindex="-1"></a><span class="do">### Change col names</span></span>
<span id="cb75-25"><a href="miss.html#cb75-25" tabindex="-1"></a><span class="fu">colnames</span>(cohen2015) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;hid&quot;</span>, <span class="st">&quot;act&quot;</span>, <span class="st">&quot;subsidy&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="st">&quot;literate&quot;</span>, <span class="st">&quot;voucher&quot;</span>, <span class="st">&quot;stratum&quot;</span>)</span>
<span id="cb75-26"><a href="miss.html#cb75-26" tabindex="-1"></a></span>
<span id="cb75-27"><a href="miss.html#cb75-27" tabindex="-1"></a><span class="do">### Declare variable types</span></span>
<span id="cb75-28"><a href="miss.html#cb75-28" tabindex="-1"></a>cohen2015<span class="sc">$</span>hid <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(cohen2015<span class="sc">$</span>hid)</span>
<span id="cb75-29"><a href="miss.html#cb75-29" tabindex="-1"></a>cohen2015<span class="sc">$</span>act <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cohen2015<span class="sc">$</span>act)</span>
<span id="cb75-30"><a href="miss.html#cb75-30" tabindex="-1"></a>cohen2015<span class="sc">$</span>subsidy <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cohen2015<span class="sc">$</span>subsidy)</span>
<span id="cb75-31"><a href="miss.html#cb75-31" tabindex="-1"></a>cohen2015<span class="sc">$</span>age <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(cohen2015<span class="sc">$</span>age)</span>
<span id="cb75-32"><a href="miss.html#cb75-32" tabindex="-1"></a>cohen2015<span class="sc">$</span>literate <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cohen2015<span class="sc">$</span>literate)</span>
<span id="cb75-33"><a href="miss.html#cb75-33" tabindex="-1"></a>cohen2015<span class="sc">$</span>voucher <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cohen2015<span class="sc">$</span>voucher)</span>
<span id="cb75-34"><a href="miss.html#cb75-34" tabindex="-1"></a>cohen2015<span class="sc">$</span>stratum <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(cohen2015<span class="sc">$</span>stratum)</span>
<span id="cb75-35"><a href="miss.html#cb75-35" tabindex="-1"></a></span>
<span id="cb75-36"><a href="miss.html#cb75-36" tabindex="-1"></a><span class="do">### Subset data for missing data analysis</span></span>
<span id="cb75-37"><a href="miss.html#cb75-37" tabindex="-1"></a>cohen2015miss <span class="ot">&lt;-</span> cohen2015 <span class="sc">|&gt;</span></span>
<span id="cb75-38"><a href="miss.html#cb75-38" tabindex="-1"></a>  <span class="fu">select</span>(act, subsidy, age, literate)</span>
<span id="cb75-39"><a href="miss.html#cb75-39" tabindex="-1"></a></span>
<span id="cb75-40"><a href="miss.html#cb75-40" tabindex="-1"></a><span class="do">### Export</span></span>
<span id="cb75-41"><a href="miss.html#cb75-41" tabindex="-1"></a><span class="fu">write.csv</span>(cohen2015, <span class="st">&quot;data/cohen2015.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-42"><a href="miss.html#cb75-42" tabindex="-1"></a><span class="fu">write.csv</span>(cohen2015miss, <span class="st">&quot;data/cohen2015miss.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="randomized-treatment-assignment-as-instrument" class="section level3 hasAnchor" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Randomized treatment assignment as instrument<a href="miss.html#randomized-treatment-assignment-as-instrument" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="miss.html#cb76-1" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/cohen2015.csv&quot;</span>)</span>
<span id="cb76-2"><a href="miss.html#cb76-2" tabindex="-1"></a></span>
<span id="cb76-3"><a href="miss.html#cb76-3" tabindex="-1"></a><span class="do">### Fit outcome and treatment models</span></span>
<span id="cb76-4"><a href="miss.html#cb76-4" tabindex="-1"></a>y_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(act <span class="sc">~</span> subsidy, </span>
<span id="cb76-5"><a href="miss.html#cb76-5" tabindex="-1"></a>         <span class="at">data =</span> d, </span>
<span id="cb76-6"><a href="miss.html#cb76-6" tabindex="-1"></a>         <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb76-7"><a href="miss.html#cb76-7" tabindex="-1"></a></span>
<span id="cb76-8"><a href="miss.html#cb76-8" tabindex="-1"></a>x_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(voucher <span class="sc">~</span> subsidy, </span>
<span id="cb76-9"><a href="miss.html#cb76-9" tabindex="-1"></a>         <span class="at">data =</span> d, </span>
<span id="cb76-10"><a href="miss.html#cb76-10" tabindex="-1"></a>         <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb76-11"><a href="miss.html#cb76-11" tabindex="-1"></a></span>
<span id="cb76-12"><a href="miss.html#cb76-12" tabindex="-1"></a><span class="do">### Intention-to-treat analysis</span></span>
<span id="cb76-13"><a href="miss.html#cb76-13" tabindex="-1"></a>YV1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(y_mod, </span>
<span id="cb76-14"><a href="miss.html#cb76-14" tabindex="-1"></a>           <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">subsidy =</span> <span class="dv">1</span>), </span>
<span id="cb76-15"><a href="miss.html#cb76-15" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb76-16"><a href="miss.html#cb76-16" tabindex="-1"></a></span>
<span id="cb76-17"><a href="miss.html#cb76-17" tabindex="-1"></a>YV0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(y_mod, </span>
<span id="cb76-18"><a href="miss.html#cb76-18" tabindex="-1"></a>           <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">subsidy =</span> <span class="dv">0</span>), </span>
<span id="cb76-19"><a href="miss.html#cb76-19" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb76-20"><a href="miss.html#cb76-20" tabindex="-1"></a></span>
<span id="cb76-21"><a href="miss.html#cb76-21" tabindex="-1"></a>itt <span class="ot">&lt;-</span> <span class="fu">mean</span>(YV1) <span class="sc">-</span> <span class="fu">mean</span>(YV0)</span>
<span id="cb76-22"><a href="miss.html#cb76-22" tabindex="-1"></a></span>
<span id="cb76-23"><a href="miss.html#cb76-23" tabindex="-1"></a><span class="do">### &quot;Compliance analysis&quot;</span></span>
<span id="cb76-24"><a href="miss.html#cb76-24" tabindex="-1"></a>XV1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(x_mod, </span>
<span id="cb76-25"><a href="miss.html#cb76-25" tabindex="-1"></a>           <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">subsidy =</span> <span class="dv">1</span>),</span>
<span id="cb76-26"><a href="miss.html#cb76-26" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)       </span>
<span id="cb76-27"><a href="miss.html#cb76-27" tabindex="-1"></a>        </span>
<span id="cb76-28"><a href="miss.html#cb76-28" tabindex="-1"></a>XV0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(x_mod, </span>
<span id="cb76-29"><a href="miss.html#cb76-29" tabindex="-1"></a>           <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">subsidy =</span> <span class="dv">0</span>), </span>
<span id="cb76-30"><a href="miss.html#cb76-30" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb76-31"><a href="miss.html#cb76-31" tabindex="-1"></a></span>
<span id="cb76-32"><a href="miss.html#cb76-32" tabindex="-1"></a>compliance <span class="ot">&lt;-</span> <span class="fu">mean</span>(XV1) <span class="sc">-</span> <span class="fu">mean</span>(XV0)</span>
<span id="cb76-33"><a href="miss.html#cb76-33" tabindex="-1"></a></span>
<span id="cb76-34"><a href="miss.html#cb76-34" tabindex="-1"></a><span class="do">### Wald IV ratio estimator / Treatment-on-the-treated estimate</span></span>
<span id="cb76-35"><a href="miss.html#cb76-35" tabindex="-1"></a>(iv <span class="ot">&lt;-</span> itt<span class="sc">/</span>compliance)</span></code></pre></div>
<pre><code>## [1] 0.9551056</code></pre>
</div>
</div>
<div id="bayesian-instrumental-variable-analysis" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Bayesian instrumental variable analysis<a href="miss.html#bayesian-instrumental-variable-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As mentioned in the text, we also want to demonstrate another approach to instrumental variable analysis, namely a Bayesian implementation.</p>
<p>Kurz (REF)[<a href="https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs" class="uri">https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs</a>] gives a rundown of instrumental variable analysis using the <code>brms</code> package, building on McElreath (2020, REF), and we follow that general approach here. We refer to those sources for further details.</p>
<p>We first define two model formulas, one for the instrument (<code>subsidy</code>) predicting treatment (<code>voucher</code>) <span class="math inline">\(\textrm{E}[X \mid V]\)</span> and another for the treatment predicting ACT uptake (<code>act</code>) model <span class="math inline">\(\textrm{E}[Y \mid X]\)</span>. This is superficially similar to how we fitted <code>y_mod</code> and <code>x_mod</code> in the frequentist setting in the text and above but note a few differences:</p>
<p>First, while the model predicting voucher use from subsidy assignment corresponds to the “compliance analysis” (<code>x_mod</code>), the model predicting ACT uptake from voucher use is not used for the Wald estimator.</p>
<p>Second, in the Bayesian setup we fit the two models in the same go. In <code>brms</code> this is facilitated by wrapping the model formulas in <code>bf()</code> and then combining these in the model fitting call using <code>+</code>. Finally, we allow the model to estimate the residual correlation between these two models by setting <code>set_rescor(TRUE)</code>.</p>
<p>Why does this work as an alternative IV estimator? Recall that we use an instrumental variable approach to deal with situations where the treatment variable (here, <code>subsidy</code>) is correlated with the error term of the outcome model – in essence, there’s an open backdoor path between treatment and the outcome. This residual correlation could be due to unobserved confounding variables of some sort, which in turn will lead to biased estimates in a simple regression model. We account for the possibility that such confounding exists by explicitly modeling this correlation.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="miss.html#cb78-1" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb78-2"><a href="miss.html#cb78-2" tabindex="-1"></a></span>
<span id="cb78-3"><a href="miss.html#cb78-3" tabindex="-1"></a><span class="co"># Treatment-instrument model formula</span></span>
<span id="cb78-4"><a href="miss.html#cb78-4" tabindex="-1"></a>xv_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(voucher <span class="sc">~</span> subsidy)</span>
<span id="cb78-5"><a href="miss.html#cb78-5" tabindex="-1"></a></span>
<span id="cb78-6"><a href="miss.html#cb78-6" tabindex="-1"></a><span class="co"># Outcome-treatment model formula</span></span>
<span id="cb78-7"><a href="miss.html#cb78-7" tabindex="-1"></a>yx_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(act <span class="sc">~</span> voucher) </span>
<span id="cb78-8"><a href="miss.html#cb78-8" tabindex="-1"></a></span>
<span id="cb78-9"><a href="miss.html#cb78-9" tabindex="-1"></a><span class="co"># Fit models and set residual correlation = TRUE</span></span>
<span id="cb78-10"><a href="miss.html#cb78-10" tabindex="-1"></a>bayes_iv_mod <span class="ot">&lt;-</span> <span class="fu">brm</span>(xv_formula <span class="sc">+</span> yx_formula <span class="sc">+</span> <span class="fu">set_rescor</span>(<span class="cn">TRUE</span>),</span>
<span id="cb78-11"><a href="miss.html#cb78-11" tabindex="-1"></a>                    <span class="at">data =</span> d, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">42</span>,</span>
<span id="cb78-12"><a href="miss.html#cb78-12" tabindex="-1"></a>                    <span class="at">file =</span> <span class="st">&quot;fits/bayes_iv&quot;</span>)</span></code></pre></div>
<p>By inspecting the summary, we see that we get essentially the same results as above – <code>act_voucher</code> corresponds to the Wald esimate – except we now have a posterior distribution to work with.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="miss.html#cb79-1" tabindex="-1"></a><span class="fu">summary</span>(bayes_iv_mod)</span></code></pre></div>
<pre><code>##  Family: MV(gaussian, gaussian) 
##   Links: mu = identity; sigma = identity
##          mu = identity; sigma = identity 
## Formula: voucher ~ subsidy 
##          act ~ voucher 
##    Data: d (Number of observations: 631) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Regression Coefficients:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## voucher_Intercept     0.13      0.03     0.06     0.20 1.00     2810     2312
## act_Intercept         0.07      0.06    -0.05     0.18 1.00     1313     1228
## voucher_subsidy       0.20      0.04     0.13     0.28 1.00     2455     2216
## act_voucher           0.96      0.20     0.60     1.40 1.00     1294     1226
## 
## Further Distributional Parameters:
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma_voucher     0.44      0.01     0.42     0.46 1.00     3324     2357
## sigma_act         0.44      0.04     0.39     0.54 1.00     1366     1265
## 
## Residual Correlations: 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## rescor(voucher,act)    -0.38      0.17    -0.68    -0.02 1.00     1312     1184
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Now, since we don’t include covariates in these models, it’s safe to just work with the coefficients here; the marginal and conditional estimates are the same in this particular case. However, in cases where the conditional and marginal effects differ, what we’ve done here is to calculate a conditional estimate, since we’re simply working with the coefficients. To get a marginal estimate in such a case, we’d have to implement something like g-computation. An explicitly marginal workflow could look like the following, following a familiar g-computation approach:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="miss.html#cb81-1" tabindex="-1"></a><span class="co"># Calculate predicted values for voucher = 1 and voucher = 0</span></span>
<span id="cb81-2"><a href="miss.html#cb81-2" tabindex="-1"></a>bayes_YX1 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_iv_mod,</span>
<span id="cb81-3"><a href="miss.html#cb81-3" tabindex="-1"></a>                             <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">voucher =</span> <span class="dv">1</span>),</span>
<span id="cb81-4"><a href="miss.html#cb81-4" tabindex="-1"></a>                             <span class="at">resp =</span> <span class="st">&quot;act&quot;</span>)</span>
<span id="cb81-5"><a href="miss.html#cb81-5" tabindex="-1"></a></span>
<span id="cb81-6"><a href="miss.html#cb81-6" tabindex="-1"></a>bayes_YX0 <span class="ot">&lt;-</span> <span class="fu">add_epred_draws</span>(<span class="at">object =</span> bayes_iv_mod,</span>
<span id="cb81-7"><a href="miss.html#cb81-7" tabindex="-1"></a>                             <span class="at">newdata =</span> <span class="fu">transform</span>(d, <span class="at">voucher =</span> <span class="dv">0</span>),</span>
<span id="cb81-8"><a href="miss.html#cb81-8" tabindex="-1"></a>                             <span class="at">resp =</span> <span class="st">&quot;act&quot;</span>)</span>
<span id="cb81-9"><a href="miss.html#cb81-9" tabindex="-1"></a></span>
<span id="cb81-10"><a href="miss.html#cb81-10" tabindex="-1"></a><span class="co"># Bayesian marginal IV</span></span>
<span id="cb81-11"><a href="miss.html#cb81-11" tabindex="-1"></a>bayes_marginal_iv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EX1 =</span> bayes_YX1<span class="sc">$</span>.epred,</span>
<span id="cb81-12"><a href="miss.html#cb81-12" tabindex="-1"></a>                                <span class="at">EX0 =</span> bayes_YX0<span class="sc">$</span>.epred,</span>
<span id="cb81-13"><a href="miss.html#cb81-13" tabindex="-1"></a>                                <span class="at">draw =</span> bayes_YX0<span class="sc">$</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb81-14"><a href="miss.html#cb81-14" tabindex="-1"></a>  <span class="co"># For each posterior draw...</span></span>
<span id="cb81-15"><a href="miss.html#cb81-15" tabindex="-1"></a>  <span class="fu">group_by</span>(draw) <span class="sc">|&gt;</span></span>
<span id="cb81-16"><a href="miss.html#cb81-16" tabindex="-1"></a>  <span class="co"># ... Calculate ATE</span></span>
<span id="cb81-17"><a href="miss.html#cb81-17" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">late =</span> <span class="fu">mean</span>(EX1 <span class="sc">-</span> EX0))</span></code></pre></div>
<p>Again, in this simple example, the conditional and marginal IV results are identical.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="miss.html#cb82-1" tabindex="-1"></a><span class="fu">mean_qi</span>(bayes_marginal_iv<span class="sc">$</span>late)</span></code></pre></div>
<pre><code>##           y      ymin     ymax .width .point .interval
## 1 0.9575332 0.6015686 1.397755   0.95   mean        qi</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="gmethods2.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="miss2.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
